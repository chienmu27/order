<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¨‚é¤ç³»çµ±ï¼ˆå¡«å–® / æŸ¥è©¢ / åˆªé™¤ / è¨­å®šï¼‰</title>

  <style>
    :root {
      --primary: #4285f4;
      --danger: #dc3545;
      --bg: #f8f9fa;
      --card: #fff;
      --text: #333;
      --muted: #666;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* å…§å®¹å€ */
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 18px 14px 60px;
    }

    /* é¸å–®å€ */
    .menu-bar {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 14px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 18px;
    }

    .brand .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }

    .nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav button {
      border: 1px solid var(--border);
      background: white;
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: 0.2s;
    }

    .nav button:hover {
      border-color: #cfd6e3;
      transform: translateY(-1px);
    }

    .nav button.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 18px;
    }

    /* ğŸ”¥ ä¿®æ­£å¾Œçš„å¡«å–®æ¡†æ¶è¨­å®š */
    .google-form-wrapper {
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* æ¡Œæ©Ÿä¸é¡¯ç¤ºå¤–æ¡†æ²è»¸ */
    }

    .form-frame {
      width: 100%;
      height: 1800px; /* æ¡Œæ©Ÿé è¨­é«˜åº¦ */
      border: none;
      border-radius: 12px;
      background: white;
      display: block;
    }

    /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­å®š */
    @media (max-width: 768px) {
      .google-form-wrapper {
        overflow: visible; /* è®“æ‰‹æ©Ÿç‰ˆå¤–æ¡†ä¸é˜»ç¤™é é¢æ»‘å‹• */
      }
      .form-frame {
        height: 2500px; /* æ‰‹æ©Ÿç‰ˆè¡¨å–®é•·åº¦é€šå¸¸è¼ƒé•· */
        -webkit-overflow-scrolling: touch; /* å„ªåŒ– iOS æ»‘å‹•æ„Ÿ */
      }
    }

    /* æŸ¥è©¢é æ¨£å¼ */
    #queryPage h2 { color: #333; text-align: center; margin: 0 0 14px; }
    #queryPage .controls {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      align-items: center;
    }
    #queryPage label { font-weight: bold; margin-right: 5px; }
    #queryPage select {
      font-size: 16px;
      padding: 8px;
      width: 220px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
    }
    #queryPage table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      overflow: hidden;
      border-radius: 10px;
    }
    #queryPage th, #queryPage td {
      border: 1px solid #e5e5e5;
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    #queryPage th { background-color: #f8f9fa; color: #555; }
    #queryPage tr:nth-child(even) { background-color: #fcfcfc; }
    #queryPage .total-row { font-weight: bold; background: #e9ecef !important; }

    /* åˆªé™¤é èˆ‡å½ˆçª—æ¨£å¼ */
    #deletePage .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    #deletePage .header-btns { display: flex; gap: 8px; }
    #deletePage .refresh-btn, #deletePage .del-all-btn { padding: 8px 12px; cursor: pointer; border-radius: 10px; font-size: 14px; font-weight: 700; }
    #deletePage .refresh-btn { background: white; border: 1px solid #ddd; }
    #deletePage .del-all-btn { background: white; border: 1px solid var(--danger); color: var(--danger); }
    #deletePage .del-all-btn:hover { background: var(--danger); color: white; }
    #deletePage .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
    #deletePage table { width: 100%; border-collapse: collapse; min-width: 720px; font-size: 14px; }
    #deletePage th, #deletePage td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
    #deletePage th { background: #f8f9fa; color: #666; font-weight: bold; }
    #deletePage .btn-del { background: #fff0f0; color: var(--danger); border: 1px solid #ffcccc; padding: 6px 12px; border-radius: 10px; cursor: pointer; font-weight: 800; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    #modalBox { background: #fff; padding: 25px; border-radius: 14px; width: 90%; max-width: 340px; text-align: center; border: 1px solid #eee; }
    #pwdInput { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns button { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
    #btnConfirm { background: var(--primary); color: #fff; }
    #btnCancel { background: #eee; color: #333; }

    /* è¨­å®šé æ¨£å¼ */
    #settingsPage .settings-card { background: white; border-radius: 16px; padding: 20px; max-width: 380px; margin: auto; border: 1px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #settingsPage .field { margin-bottom: 15px; }
    #settingsPage label { display: block; font-size: 14px; margin-bottom: 5px; color: #666; font-weight: bold; }
    #settingsPage input, #settingsPage select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    #settingsPage button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  </style>
</head>

<body>

  <div class="container">
    <div class="menu-bar">
      <div class="brand">
        <span class="dot"></span>
        <span>è¨‚é¤ç³»çµ±</span>
      </div>
      <div class="nav">
        <button class="active" data-page="formPage">ğŸ“ å¡«å–®</button>
        <button data-page="queryPage">ğŸ” æŸ¥è©¢</button>
        <button data-page="deletePage">ğŸ—‘ï¸ åˆªé™¤</button>
        <button data-page="settingsPage">âš™ï¸ è¨­å®š</button>
      </div>
    </div>

    <section id="formPage" class="page active">
      <div class="card google-form-wrapper">
        <iframe
          class="form-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?usp=header"
          loading="lazy"
        >è¼‰å…¥ä¸­â€¦</iframe>
      </div>
    </section>

    <section id="queryPage" class="page">
      <div class="card">
        <h2 id="sheetTitle">è¨‚å–®æŸ¥è©¢ç³»çµ±</h2>
        <div class="controls">
          <div>
            <label>è¨‚è³¼äººå“¡ï¼š</label>
            <select id="buyerSelect"><option value="">--è«‹é¸æ“‡--</option></select>
          </div>
          <div>
            <label>è¨‚å–®çµ±è¨ˆï¼š</label>
            <select id="listSelect">
              <option value="">--è«‹é¸æ“‡--</option>
              <option value="list1">è³¼è²·äºº / é‡‘é¡ç¸½è¨ˆ</option>
              <option value="list2">é …ç›® / è¨‚è³¼æ•¸é‡ç¸½è¨ˆ</option>
            </select>
          </div>
        </div>
        <table id="resultTable"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="deletePage" class="page">
      <div class="card">
        <div class="header">
          <h3 style="margin:0;">ğŸ“‹ è¨‚å–®ç®¡ç†æ¸…å–®</h3>
          <div class="header-btns">
            <button class="refresh-btn" onclick="fetchOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="del-all-btn" onclick="prepareDelete('all')">ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤</button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>æ™‚é–“</th><th>è¨‚é¤äººå“¡</th><th>ä¾¿ç•¶å“é …</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="settingsPage" class="page">
      <div class="settings-card">
        <h3>è¨‚é¤ç®¡ç†ç³»çµ±</h3>
        <div class="field">
          <label>è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2026-01-26">
        </div>
        <div class="field">
          <label>åº—å®¶é¸å–®</label>
          <select id="restaurant"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        <div class="field"><label>å¸³è™Ÿ</label><input type="text" id="acc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>
        <div class="field"><label>å¯†ç¢¼</label><input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
        <button onclick="sendData()" id="btn">é€å‡ºè¨­å®š</button>
        <div id="status"></div>
      </div>
    </section>
  </div>

  <div id="loadingOverlay"><div class="spinner"></div><div id="loadingText" style="margin-top:15px; color:#555;">æ­£åœ¨è™•ç†ä¸­...</div></div>
  <div id="modalOverlay">
    <div id="modalBox">
      <h3 style="margin-top:0;">èº«åˆ†é©—è­‰</h3>
      <p id="modalDesc" style="color:#666; font-size:14px;">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</p>
      <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      <div class="modal-btns"><button id="btnCancel">å–æ¶ˆ</button><button id="btnConfirm">ç¢ºèª</button></div>
    </div>
  </div>

<script>
/* é é¢åˆ‡æ› */
(function initNav(){
  const navButtons = document.querySelectorAll(".nav button");
  const pages = document.querySelectorAll(".page");
  function showPage(id){
    pages.forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    navButtons.forEach(b => b.classList.remove("active"));
    document.querySelector(`.nav button[data-page="${id}"]`).classList.add("active");
    if(id === "deletePage") fetchOrders();
  }
  navButtons.forEach(btn => btn.addEventListener("click", () => showPage(btn.dataset.page)));
})();

/* é€šç”¨ CSV è§£æ */
function parseCSV(text) {
  const result = []; let cur = []; let curVal = ""; let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i]; const next = text[i+1];
    if (inQuotes) {
      if (ch === '"' && next === '"') { curVal += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else curVal += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { cur.push(curVal); curVal = ""; }
      else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
      else if (ch !== '\r') curVal += ch;
    }
  }
  if (curVal !== "" || cur.length > 0) { cur.push(curVal); result.push(cur); }
  return result;
}

/* æŸ¥è©¢åŠŸèƒ½ */
const queryCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
let queryHeader = []; let queryDataRows = [];
async function loadQueryCSV() {
  try {
    const res = await fetch(queryCsvUrl); const text = await res.text(); const parsed = parseCSV(text);
    const rows = parsed.filter(r => r.some(c => (c ?? "").trim() !== ""));
    if (rows.length > 1) {
      document.getElementById("sheetTitle").innerText = (rows[0][2] || "è¨‚å–®æŸ¥è©¢") + " (" + (rows[0][0] || "") + ")";
      queryHeader = rows[1]; queryDataRows = rows.slice(2); buildBuyerDropdown();
    }
  } catch (e) { alert("è®€å–å¤±æ•—"); }
}

function buildBuyerDropdown() {
  const buyerIdx = queryHeader.indexOf("è³¼è²·äºº");
  const set = new Set();
  queryDataRows.forEach(r => { const val = (r[buyerIdx] ?? "").trim(); if (val && val !== "è³¼è²·äºº") set.add(val); });
  const select = document.getElementById("buyerSelect");
  select.innerHTML = '<option value="">--è«‹é¸æ“‡--</option><option value="ALL">å…¨éƒ¨è¨‚å–®æ¸…å–®</option>';
  [...set].sort().forEach(v => { const op = document.createElement("option"); op.value = v; op.textContent = v; select.appendChild(op); });
}

function renderNormalTable(buyer) {
  const tbody = document.querySelector("#resultTable tbody");
  const thead = document.querySelector("#resultTable thead");
  thead.innerHTML = `<tr><th>è³¼è²·äºº</th><th>é …ç›®</th><th>å–®åƒ¹</th><th>åŠ é£¯</th><th>åŠ æ–™</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>`;
  tbody.innerHTML = "";
  const idx = { item: queryHeader.indexOf("é …ç›®"), price: queryHeader.indexOf("å–®åƒ¹"), rice: queryHeader.indexOf("åŠ é£¯"), add: queryHeader.indexOf("åŠ æ–™"), qty: queryHeader.indexOf("æ•¸é‡"), sub: queryHeader.indexOf("å°è¨ˆ"), user: queryHeader.indexOf("è³¼è²·äºº") };
  let filtered = buyer === "ALL" ? queryDataRows : queryDataRows.filter(r => (r[idx.user] ?? "").trim() === buyer);
  let total = 0;
  filtered.forEach(r => {
    const s = Number(r[idx.sub]) || 0; total += s;
    tbody.innerHTML += `<tr><td>${r[idx.user]||""}</td><td>${r[idx.item]||""}</td><td>${r[idx.price]||""}</td><td>${r[idx.rice]||""}</td><td>${r[idx.add]||""}</td><td>${r[idx.qty]||""}</td><td>${s}</td></tr>`;
  });
  if(buyer !== "ALL") tbody.innerHTML += `<tr class="total-row"><td colspan="6">åˆè¨ˆ</td><td>${total}</td></tr>`;
}

document.getElementById("buyerSelect").addEventListener("change", e => { if(e.target.value) renderNormalTable(e.target.value); });
loadQueryCSV();

/* åˆªé™¤åŠŸèƒ½ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
let targetRow = null;
async function fetchOrders() {
  showLoading(true, "è¼‰å…¥ä¸­...");
  try {
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv&t="+Date.now());
    const text = await res.text(); const rows = parseCSV(text);
    const tbody = document.getElementById('tableBody');
    if (rows.length < 2) { tbody.innerHTML = '<tr><td colspan="6">å°šç„¡è¨‚å–®</td></tr>'; return; }
    tbody.innerHTML = rows.slice(1).map((row, i) => `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]||""}</td><td><button class="btn-del" onclick="prepareDelete(${i+2})">åˆªé™¤</button></td></tr>`).join('');
  } catch (e) { alert("è®€å–å¤±æ•—"); } finally { showLoading(false); }
}

function prepareDelete(row) { targetRow = row; document.getElementById('modalOverlay').style.display = 'flex'; }
document.getElementById('btnCancel').onclick = () => document.getElementById('modalOverlay').style.display = 'none';
document.getElementById('btnConfirm').onclick = async () => {
  const pwd = document.getElementById('pwdInput').value; if(!pwd) return;
  document.getElementById('modalOverlay').style.display = 'none';
  showLoading(true, "è™•ç†ä¸­...");
  try {
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ row: targetRow, password: pwd }) });
    const result = await res.json(); alert(result.message); if(result.status === 'success') fetchOrders();
  } catch(e) { alert("åŸ·è¡Œå¤±æ•—"); } finally { showLoading(false); }
};

function showLoading(show, text) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; if(text) document.getElementById('loadingText').innerText = text; }

/* è¨­å®šåŠŸèƒ½ */
const setUrl = 'https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec';
async function loadSettingsOptions() {
  const res = await fetch(setUrl + "?action=getOptions");
  const data = await res.json();
  const select = document.getElementById('restaurant'); select.innerHTML = '';
  data.forEach(item => { if(item) { let opt = document.createElement('option'); opt.value = opt.innerHTML = item; select.appendChild(opt); } });
}
loadSettingsOptions();

function sendData() {
  const btn = document.getElementById('btn'); const status = document.getElementById('status');
  const d = document.getElementById('orderDate').value; const s = document.getElementById('restaurant').value;
  const a = document.getElementById('acc').value; const p = document.getElementById('pwd').value;
  if (!a || !p || !d || !s) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
  btn.disabled = true; status.innerHTML = "è™•ç†ä¸­...";
  fetch(`${setUrl}?action=submit&date=${d}&store=${s}&acc=${a}&pwd=${p}`)
    .then(r => r.text()).then(t => { status.innerHTML = t; status.className = t.includes("æˆåŠŸ") ? "success" : "error"; btn.disabled = false; });
}
</script>
</body>
</html>
