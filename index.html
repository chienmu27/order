<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨‚é¤ç®¡ç†ç³»çµ±ï¼ˆå¡«å–® / æŸ¥è©¢ / åˆªé™¤ / è¨­å®šï¼‰</title>
  <style>
    :root {
      --primary-color: #4285f4;
      --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
      --btn-blue: #1e88ff;
      --btn-red: #d32f2f;
      --shadow: 0 12px 30px rgba(0,0,0,0.1);
      --border-radius: 20px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft JhengHei", system-ui, sans-serif;
      margin: 0; padding: 30px 10px;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex; justify-content: center;
    }

    .wrap { width: min(1000px, 100%); }

    /* æ¨™é¡Œèˆ‡å°è¦½ */
    .title-container { text-align: center; margin-bottom: 25px; }
    h1 {
      background: var(--primary-color); color: white;
      padding: 10px 30px; border-radius: 50px;
      display: inline-flex; align-items: center; gap: 12px;
      font-size: clamp(18px, 4.5vw, 28px);
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
    }

    .nav-buttons { 
      display: flex; justify-content: center; gap: 10px; 
      margin-bottom: 25px; flex-wrap: wrap; 
    }

    .btn {
      padding: 12px 20px; font-size: 15px; font-weight: bold; cursor: pointer;
      border: none; color: white; border-radius: 50px;
      background: linear-gradient(180deg, var(--btn-blue) 0%, #1565c0 100%);
      transition: 0.3s; min-width: 100px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    .btn.active { background: #0d47a1; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

    /* å€å¡Šè¨­å®š */
    .section {
      display: none; background: rgba(255, 255, 255, 0.95);
      padding: 20px; border-radius: var(--border-radius); 
      box-shadow: var(--shadow);
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .active { display: block; }

    /* ğŸ”¥ è¡¨å–®å…§åµŒä¿®æ”¹ï¼šè®“æ‰‹æ©Ÿèƒ½æ»‘å‹•æ•´å€‹é é¢ */
    .form-wrapper { width: 100%; overflow: visible; }
    iframe { 
      width: 100%; height: 1600px; /* è¨­å®šè¶³å¤ é«˜åº¦é¿å…å…§éƒ¨æ²è»¸ */
      border: none; border-radius: 12px; background: white; 
    }

    /* æŸ¥è©¢é æ¨£å¼ */
    .search-box { 
      padding-bottom: 20px; border-bottom: 2px dashed #ccc; 
      margin-bottom: 20px; text-align: center;
    }
    select, input[type="date"], input[type="text"], input[type="password"] {
      padding: 10px; border: 2px solid #ddd; border-radius: 12px;
      font-size: 16px; margin: 5px; outline: none;
    }
    
    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .table-container { width: 100%; overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
    th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
    th { background: #f5f5f5; color: #333; }
    .total-row { background: #e3f2fd; font-weight: bold; }

    /* åˆªé™¤æŒ‰éˆ• */
    .btn-del {
      background: #ffebee; color: var(--btn-red); border: 1px solid #ffcdd2;
      padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .btn-del:hover { background: var(--btn-red); color: white; }

    /* å½ˆçª—æ¨£å¼ */
    #modalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 3000;
      display: none; justify-content: center; align-items: center;
    }
    #modalBox {
      background: #fff; padding: 25px; border-radius: 14px; width: 90%; max-width: 340px;
      text-align: center; box-shadow: var(--shadow);
    }

    /* è¨­å®šé å¡ç‰‡ */
    .settings-card { max-width: 400px; margin: 0 auto; text-align: left; }
    .field { margin-bottom: 15px; }
    .field label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .field input, .field select { width: 100%; margin: 0; }

    @media (max-width: 600px) {
      body { padding: 15px 10px; }
      iframe { height: 2000px; } /* æ‰‹æ©Ÿç‰ˆè¡¨å–®é€šå¸¸æœƒæ‹‰é•· */
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="title-container"><h1>ğŸ± è¨‚é¤ç®¡ç†ç³»çµ±</h1></div>
    
    <div class="nav-buttons">
      <button class="btn active" onclick="showSection('form-page', this)">ğŸ“ å¡«å–®</button>
      <button class="btn" onclick="showSection('query-page', this)">ğŸ” æŸ¥è©¢</button>
      <button class="btn" onclick="showSection('delete-page', this)">ğŸ—‘ï¸ åˆªé™¤</button>
      <button class="btn" onclick="showSection('settings-page', this)">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="form-page" class="section active">
      <div class="form-wrapper">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?embedded=true">è¼‰å…¥ä¸­â€¦</iframe>
      </div>
    </div>

    <div id="query-page" class="section">
      <div class="search-box">
        <h3 id="sheetTitle">è¨‚å–®çµ±è¨ˆæŸ¥è©¢</h3>
        <select id="buyerSelect"><option value="">--é¸æ“‡è¨‚è³¼äºº--</option></select>
        <select id="listSelect">
          <option value="">--çµ±è¨ˆæ¸…å–®--</option>
          <option value="list1">äººå“¡ / é‡‘é¡ç¸½è¨ˆ</option>
          <option value="list2">å“é … / æ•¸é‡ç¸½è¨ˆ</option>
        </select>
      </div>
      <div class="table-container">
        <table id="resultTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="delete-page" class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin:0;">ğŸ“‹ è¨‚å–®ç®¡ç†</h3>
        <div>
          <button class="btn" style="min-width: 80px; padding: 8px;" onclick="fetchOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
          <button class="btn" style="min-width: 80px; padding: 8px; background: var(--btn-red);" onclick="prepareDelete('all')">ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>æ™‚é–“</th><th>äººå“¡</th><th>å“é …</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="deleteTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="settings-page" class="section">
      <div class="settings-card">
        <h3 style="text-align: center;">ç³»çµ±å¾Œå°è¨­å®š</h3>
        <div class="field">
          <label>è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2026-02-13">
        </div>
        <div class="field">
          <label>åº—å®¶é¸å–®</label>
          <select id="restaurantSelect"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <div class="field">
          <label>å¾Œå°å¸³è™Ÿ</label>
          <input type="text" id="acc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
        </div>
        <div class="field">
          <label>å¾Œå°å¯†ç¢¼</label>
          <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>
        <button class="btn" onclick="sendSettings()" id="settingsBtn" style="width: 100%;">å„²å­˜ä¸¦é€å‡º</button>
        <div id="statusMsg" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
      </div>
    </div>
  </div>

  <div id="modalOverlay">
    <div id="modalBox">
      <h3 id="modalTitle">ç®¡ç†å“¡é©—è­‰</h3>
      <p id="modalDesc" style="color: #666; font-size: 14px;">åŸ·è¡Œæ­¤æ“ä½œéœ€è¦è¼¸å…¥ç®¡ç†å¯†ç¢¼</p>
      <input type="password" id="adminPwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="width: 100%;">
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn" id="btnCancel" style="background: #eee; color: #333; flex:1;">å–æ¶ˆ</button>
        <button class="btn" id="btnConfirm" style="flex:1;">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    // --- å…±ç”¨åƒæ•¸ ---
    const QUERY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
    const DELETE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
    const DELETE_API = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
    const SETTINGS_API = "https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec";

    let queryRows = [];
    let targetDeleteRow = null;

    // --- é é¢åˆ‡æ› ---
    function showSection(id, btn) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".nav-buttons .btn").forEach(b => b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      btn.classList.add("active");
      if(id === 'delete-page') fetchOrders();
    }

    // --- CSV è§£æå™¨ ---
    function parseCSV(text) {
      const result = [];
      let cur = [];
      let curVal = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        let ch = text[i], next = text[i+1];
        if (inQuotes) {
          if (ch === '"' && next === '"') { curVal += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else curVal += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { cur.push(curVal); curVal = ""; }
          else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
          else if (ch !== '\r') curVal += ch;
        }
      }
      if (cur.length > 0 || curVal !== "") { cur.push(curVal); result.push(cur); }
      return result;
    }

    // --- æŸ¥è©¢åŠŸèƒ½ ---
    async function initQuery() {
      try {
        const res = await fetch(QUERY_CSV);
        const text = await res.text();
        const data = parseCSV(text).filter(r => r.length > 1);
        if(data.length < 2) return;
        
        document.getElementById("sheetTitle").innerText = `${data[0][2] || "è¨‚å–®æŸ¥è©¢"} (${data[0][0] || ""})`;
        const header = data[1];
        queryRows = data.slice(2);

        const buyerIdx = header.indexOf("è³¼è²·äºº");
        const buyers = [...new Set(queryRows.map(r => r[buyerIdx]).filter(v => v))];
        const select = document.getElementById("buyerSelect");
        select.innerHTML = '<option value="">--é¸æ“‡è¨‚è³¼äºº--</option><option value="ALL">å…¨éƒ¨è¨‚å–®æ¸…å–®</option>';
        buyers.sort().forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
      } catch(e) { console.error("æŸ¥è©¢è¼‰å…¥å¤±æ•—", e); }
    }

    document.getElementById("buyerSelect").onchange = function() {
      document.getElementById("listSelect").value = "";
      renderTable(this.value);
    };

    document.getElementById("listSelect").onchange = function() {
      document.getElementById("buyerSelect").value = "";
      if(this.value === "list1") renderSummary("è³¼è²·äºº", "å°è¨ˆ", "é‡‘é¡ç¸½è¨ˆ");
      if(this.value === "list2") renderSummary("é …ç›®", "æ•¸é‡", "æ•¸é‡ç¸½è¨ˆ");
    };

    function renderTable(buyer) {
      const table = document.getElementById("resultTable");
      if(!buyer) { table.innerHTML = ""; return; }
      let filtered = buyer === "ALL" ? queryRows : queryRows.filter(r => r[1] === buyer);
      let html = `<thead><tr><th>äºº</th><th>é …</th><th>å–®</th><th>åŠ </th><th>æ–™</th><th>æ•¸</th><th>è¨ˆ</th></tr></thead><tbody>`;
      let total = 0;
      filtered.forEach(r => {
        total += Number(r[6]) || 0;
        html += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[8]}</td><td>${r[6]}</td></tr>`;
      });
      html += `<tr class="total-row"><td colspan="6">åˆè¨ˆ</td><td>${total}</td></tr></tbody>`;
      table.innerHTML = html;
    }

    function renderSummary(keyLabel, valLabel, totalLabel) {
      const table = document.getElementById("resultTable");
      const summary = {};
      const keyIdx = keyLabel === "è³¼è²·äºº" ? 1 : 2;
      const valIdx = valLabel === "å°è¨ˆ" ? 6 : 8;

      queryRows.forEach(r => {
        const k = r[keyIdx];
        const v = Number(r[valIdx]) || 0;
        if(k) summary[k] = (summary[k] || 0) + v;
      });

      let html = `<thead><tr><th>${keyLabel}</th><th>${totalLabel}</th></tr></thead><tbody>`;
      let grandTotal = 0;
      Object.keys(summary).sort().forEach(k => {
        grandTotal += summary[k];
        html += `<tr><td>${k}</td><td>${summary[k]}</td></tr>`;
      });
      html += `<tr class="total-row"><td>ç¸½è¨ˆ</td><td>${grandTotal}</td></tr></tbody>`;
      table.innerHTML = html;
    }

    // --- åˆªé™¤åŠŸèƒ½ ---
    async function fetchOrders() {
      const tbody = document.getElementById("deleteTableBody");
      tbody.innerHTML = '<tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const res = await fetch(`${DELETE_CSV}&t=${Date.now()}`);
        const text = await res.text();
        const data = parseCSV(text).filter(r => r.length > 1);
        if(data.length < 2) { tbody.innerHTML = '<tr><td colspan="6">æŸ¥ç„¡è¨‚å–®</td></tr>'; return; }

        let html = "";
        data.slice(1).forEach((r, idx) => {
          html += `<tr>
            <td style="font-size:11px">${r[0].split(" ")[1] || r[0]}</td>
            <td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
            <td style="font-size:11px">${r[4]||""}</td>
            <td><button class="btn-del" onclick="prepareDelete(${idx+2})">åˆª</button></td>
          </tr>`;
        });
        tbody.innerHTML = html;
      } catch(e) { tbody.innerHTML = '<tr><td colspan="6">è®€å–å¤±æ•—</td></tr>'; }
    }

    function prepareDelete(row) {
      targetDeleteRow = row;
      document.getElementById("modalOverlay").style.display = "flex";
      document.getElementById("adminPwdInput").value = "";
    }

    document.getElementById("btnCancel").onclick = () => document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("btnConfirm").onclick = async () => {
      const pwd = document.getElementById("adminPwdInput").value;
      if(!pwd) return;
      document.getElementById("modalOverlay").style.display = "none";
      try {
        const res = await fetch(DELETE_API, {
          method: "POST",
          body: JSON.stringify({ row: targetDeleteRow, password: pwd })
        });
        const result = await res.json();
        alert(result.message);
        if(result.status === "success") fetchOrders();
      } catch(e) { alert("é€£ç·šå¤±æ•—"); }
    };

    // --- è¨­å®šåŠŸèƒ½ ---
    async function initSettings() {
      try {
        const res = await fetch(`${SETTINGS_API}?action=getOptions`);
        const options = await res.json();
        const sel = document.getElementById("restaurantSelect");
        sel.innerHTML = "";
        options.forEach(opt => sel.innerHTML += `<option value="${opt}">${opt}</option>`);
      } catch(e) { console.error("è¨­å®šé¸å–®è¼‰å…¥å¤±æ•—"); }
    }

    async function sendSettings() {
      const btn = document.getElementById("settingsBtn");
      const status = document.getElementById("statusMsg");
      const data = {
        date: document.getElementById("orderDate").value,
        store: document.getElementById("restaurantSelect").value,
        acc: document.getElementById("acc").value,
        pwd: document.getElementById("pwd").value
      };

      if(!data.acc || !data.pwd) { alert("è«‹è¼¸å…¥å¸³å¯†"); return; }
      
      btn.disabled = true;
      status.innerText = "æ­£åœ¨é€å‡ºè¨­å®š...";
      
      try {
        const url = `${SETTINGS_API}?action=submit&date=${data.date}&store=${encodeURIComponent(data.store)}&acc=${data.acc}&pwd=${data.pwd}`;
        const res = await fetch(url);
        const result = await res.text();
        status.innerText = result;
        status.style.color = result.includes("æˆåŠŸ") ? "green" : "red";
      } catch(e) { status.innerText = "é€£ç·šå¤±æ•—"; }
      btn.disabled = false;
    }

    // åˆå§‹åŒ–
    window.onload = () => {
      initQuery();
      initSettings();
    };
  </script>
</body>
</html>
