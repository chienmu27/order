<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨‚é¤ç®¡ç†ç³»çµ± (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
  <style>
    :root {
      --primary-color: #2e7d32; /* æ£®æ—ç¶  */
      --primary-light: #4caf50;
      --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%);
      --btn-blue: linear-gradient(180deg, #1e88ff 0%, #1565c0 100%);
      --btn-red: linear-gradient(180deg, #ff5252 0%, #d32f2f 100%);
      --card-bg: rgba(255, 255, 255, 0.9);
      --shadow: 0 12px 30px rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft JhengHei", system-ui, sans-serif;
      margin: 0; padding: 20px 10px;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex; justify-content: center;
    }

    .wrap { width: min(1000px, 100%); }

    /* æ¨™é¡Œæ¨£å¼ */
    .title-container { text-align: center; margin-bottom: 20px; }
    h1 {
      background: var(--primary-color); color: white;
      padding: 12px 35px; border-radius: 50px;
      display: inline-flex; align-items: center; gap: 12px;
      font-size: clamp(20px, 5vw, 28px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* å°è¦½æŒ‰éˆ• */
    .nav-buttons { 
      display: flex; justify-content: center; gap: 10px; 
      margin-bottom: 20px; flex-wrap: wrap; 
    }
    .btn {
      padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer;
      border: none; color: white; border-radius: 50px;
      background: var(--btn-blue);
      transition: 0.3s; min-width: 100px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .btn.active { background: var(--primary-color); box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

    /* å€å¡Šè¨­å®š */
    .section {
      display: none; background: var(--card-bg);
      padding: 20px; border-radius: 20px; box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    .active { display: block; }

    /* --- å¡«å–®è¡¨å–® iframe å„ªåŒ– --- */
    .iframe-container {
      width: 100%;
      overflow: hidden; /* é˜²æ­¢å…§æ¡†å‡ºç¾æ²è»¸ */
    }
    iframe { 
      width: 100%; 
      height: 1800px; /* é è¨­é«˜åº¦è¶³å¤ é¡¯ç¤ºæ•´å€‹è¡¨å–® */
      border: none; 
      border-radius: 12px; 
      background: white; 
    }

    /* æŸ¥è©¢ã€åˆªé™¤ã€è¨­å®šé é¢è¡¨æ ¼èˆ‡å¡ç‰‡æ¨£å¼ (ç¶­æŒåŸåŠŸèƒ½å¤–è§€) */
    .controls, .settings-card {
      background: white; padding: 20px; border-radius: 15px;
      margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
    th { background: #f4f7f4; color: var(--primary-color); }
    .total-row { background: #e8f5e9; font-weight: bold; }
    
    /* åˆªé™¤æŒ‰éˆ• */
    .btn-del { background: var(--btn-red); color: white; border: none; padding: 5px 15px; border-radius: 50px; cursor: pointer; }

    /* è¼‰å…¥èˆ‡å½ˆçª— */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 999;
      display: none; justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      iframe { height: 1600px; } /* æ‰‹æ©Ÿæ¿é«˜åº¦å¾®èª¿ */
      .nav-buttons .btn { flex: 1 1 40%; }
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="title-container"><h1>ğŸ± è¨‚é¤ç®¡ç†ç³»çµ±</h1></div>
    
    <div class="nav-buttons">
      <button class="btn active" onclick="showSection('form-section', this)">ğŸ“ å¡«å–®å ±å</button>
      <button class="btn" onclick="showSection('query-section', this)">ğŸ” è¨‚å–®æŸ¥è©¢</button>
      <button class="btn" onclick="showSection('delete-section', this)">ğŸ—‘ï¸ è¨‚å–®ç®¡ç†</button>
      <button class="btn" onclick="showSection('settings-section', this)">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>

    <div id="form-section" class="section active">
      <div class="iframe-container">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?embedded=true">è¼‰å…¥ä¸­â€¦</iframe>
      </div>
    </div>

    <div id="query-section" class="section">
      <h2 id="sheetTitle" style="text-align:center;">è¨‚å–®æŸ¥è©¢çµ±è¨ˆ</h2>
      <div class="controls">
        <div style="margin-bottom:15px;">
          <label>è¨‚è³¼äººå“¡ï¼š</label>
          <select id="buyerSelect" style="padding:8px; border-radius:8px; width:100%; max-width:200px;">
            <option value="">--è«‹é¸æ“‡--</option>
          </select>
        </div>
        <div>
          <label>çµ±è¨ˆå ±è¡¨ï¼š</label>
          <select id="listSelect" style="padding:8px; border-radius:8px; width:100%; max-width:200px;">
            <option value="">--è«‹é¸æ“‡--</option>
            <option value="list1">å€‹äººé‡‘é¡ç¸½è¨ˆ</option>
            <option value="list2">å“é …æ•¸é‡ç¸½è¨ˆ</option>
          </select>
        </div>
      </div>
      <div style="overflow-x:auto;">
        <table id="resultTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="delete-section" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">ğŸ“‹ è¨‚å–®æ¸…å–®</h3>
        <button class="btn" onclick="fetchOrders()" style="min-width:80px; font-size:13px;">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr><th>æ™‚é–“</th><th>äººå“¡</th><th>å“é …</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="settings-section" class="section">
      <div class="settings-card" style="max-width:400px; margin:auto;">
        <h3 style="text-align:center;">âš™ï¸ ç³»çµ±åƒæ•¸è¨­å®š</h3>
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:5px;">è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
        </div>
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:5px;">ç›®å‰åº—å®¶</label>
          <select id="restaurant" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:5px;">ç®¡ç†å¸³è™Ÿ</label>
          <input type="text" id="acc" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:5px;">ç®¡ç†å¯†ç¢¼</label>
          <input type="password" id="pwd" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
        </div>
        <button class="btn" onclick="sendData()" id="btn" style="width:100%;">å„²å­˜è¨­å®š</button>
        <div id="status" style="margin-top:10px; text-align:center;"></div>
      </div>
    </div>
  </div>

  <div id="modalOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000;">
    <div style="background:white; padding:25px; border-radius:20px; width:90%; max-width:320px; text-align:center;">
      <h3>èº«åˆ†é©—è­‰</h3>
      <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" style="width:100%; padding:10px; margin:15px 0; border:1px solid #ddd; border-radius:10px;">
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="document.getElementById('modalOverlay').style.display='none'" style="background:#eee; color:#333; flex:1;">å–æ¶ˆ</button>
        <button class="btn" id="btnConfirm" style="flex:1;">åŸ·è¡Œ</button>
      </div>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loadingText">è™•ç†ä¸­...</p>
  </div>

  <script>
    // --- å…±ç”¨èˆ‡å°è¦½é‚è¼¯ ---
    function showSection(id, btn) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".nav-buttons .btn").forEach(b => b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      btn.classList.add("active");
      if (id === 'delete-section') fetchOrders();
      window.scrollTo(0, 0); // åˆ‡æ›é é¢æ™‚å›åˆ°é ‚ç«¯
    }

    // --- CSV è§£æå™¨ ---
    function parseCSV(text) {
      const result = [];
      let cur = [];
      let curVal = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"' && text[i+1] === '"') { curVal += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else curVal += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { cur.push(curVal); curVal = ""; }
          else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
          else if (ch !== '\r') curVal += ch;
        }
      }
      if (curVal || cur.length) { cur.push(curVal); result.push(cur); }
      return result;
    }

    /* =========================
       æŸ¥è©¢åŠŸèƒ½ (QUERY)
    ========================= */
    const queryCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
    let queryData = [];
    let queryHeader = [];

    async function loadQueryData() {
      try {
        const res = await fetch(queryCsvUrl);
        const text = await res.text();
        const rows = parseCSV(text).filter(r => r.length > 1);
        if(rows.length > 1) {
          document.getElementById("sheetTitle").innerText = rows[0][2] + " è¨‚é¤çµ±è¨ˆ";
          queryHeader = rows[1];
          queryData = rows.slice(2);
          const buyerIdx = queryHeader.indexOf("è³¼è²·äºº");
          const buyers = [...new Set(queryData.map(r => r[buyerIdx]).filter(v => v))];
          const select = document.getElementById("buyerSelect");
          buyers.sort().forEach(b => {
            const opt = document.createElement("option"); opt.value = b; opt.innerText = b; select.appendChild(opt);
          });
        }
      } catch (e) { console.error("æŸ¥è©¢è¼‰å…¥å¤±æ•—"); }
    }

    document.getElementById("buyerSelect").onchange = function() {
      const val = this.value; if(!val) return;
      document.getElementById("listSelect").value = "";
      renderTable(queryData.filter(r => r[queryHeader.indexOf("è³¼è²·äºº")] === val), "normal");
    };

    document.getElementById("listSelect").onchange = function() {
      const val = this.value; if(!val) return;
      document.getElementById("buyerSelect").value = "";
      renderTable(queryData, val);
    };

    function renderTable(data, mode) {
      const thead = document.querySelector("#resultTable thead");
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      
      if(mode === "normal") {
        thead.innerHTML = "<tr><th>å“é …</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>";
        let sum = 0;
        data.forEach(r => {
          const sub = parseInt(r[queryHeader.indexOf("å°è¨ˆ")]) || 0;
          sum += sub;
          tbody.innerHTML += `<tr><td>${r[queryHeader.indexOf("é …ç›®")]}</td><td>${r[queryHeader.indexOf("å–®åƒ¹")]}</td><td>${r[queryHeader.indexOf("æ•¸é‡")]}</td><td>${sub}</td></tr>`;
        });
        tbody.innerHTML += `<tr class="total-row"><td colspan="3">å€‹äººç¸½è¨ˆ</td><td>${sum}</td></tr>`;
      } else if(mode === "list1") {
        thead.innerHTML = "<tr><th>è³¼è²·äºº</th><th>é‡‘é¡ç¸½è¨ˆ</th></tr>";
        const map = {};
        data.forEach(r => {
          const name = r[queryHeader.indexOf("è³¼è²·äºº")];
          const sub = parseInt(r[queryHeader.indexOf("å°è¨ˆ")]) || 0;
          map[name] = (map[name] || 0) + sub;
        });
        Object.keys(map).sort().forEach(k => { tbody.innerHTML += `<tr><td>${k}</td><td>${map[k]}</td></tr>`; });
      } else if(mode === "list2") {
        thead.innerHTML = "<tr><th>å“é …</th><th>æ•¸é‡ç¸½è¨ˆ</th></tr>";
        const map = {};
        data.forEach(r => {
          const item = r[queryHeader.indexOf("é …ç›®")];
          const qty = parseInt(r[queryHeader.indexOf("æ•¸é‡")]) || 0;
          map[item] = (map[item] || 0) + qty;
        });
        Object.keys(map).sort().forEach(k => { tbody.innerHTML += `<tr><td>${k}</td><td>${map[k]}</td></tr>`; });
      }
    }

    /* =========================
       åˆªé™¤åŠŸèƒ½ (DELETE)
    ========================= */
    const delCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
    const GAS_DEL_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";

    async function fetchOrders() {
      showLoading(true, "è®€å–è³‡æ–™ä¸­...");
      try {
        const res = await fetch(`${delCsvUrl}&t=${Date.now()}`);
        const text = await res.text();
        const rows = parseCSV(text).slice(1);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = rows.filter(r => r[1]).map((r, i) => `
          <tr>
            <td style="font-size:11px;">${r[0].split(" ")[0]}</td>
            <td>${r[1]}</td>
            <td>${r[2]}</td>
            <td>${r[3]}</td>
            <td><button class="btn-del" onclick="askDelete(${i+2})">åˆªé™¤</button></td>
          </tr>
        `).join("");
      } catch (e) { alert("è®€å–å¤±æ•—"); }
      showLoading(false);
    }

    let pendingDeleteRow = null;
    function askDelete(row) {
      pendingDeleteRow = row;
      document.getElementById("modalOverlay").style.display = "flex";
    }

    document.getElementById("btnConfirm").onclick = async function() {
      const pwd = document.getElementById("pwdInput").value;
      if(!pwd) return;
      document.getElementById("modalOverlay").style.display = "none";
      showLoading(true, "åŸ·è¡Œåˆªé™¤ä¸­...");
      try {
        const res = await fetch(GAS_DEL_URL, {
          method: "POST",
          body: JSON.stringify({ row: pendingDeleteRow, password: pwd })
        });
        const json = await res.json();
        alert(json.message);
        if(json.status === "success") fetchOrders();
      } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
      showLoading(false);
    };

    /* =========================
       è¨­å®šåŠŸèƒ½ (SETTINGS)
    ========================= */
    const GAS_SET_URL = "https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec";

    function loadSettings() {
      fetch(GAS_SET_URL + "?action=getOptions")
        .then(res => res.json())
        .then(data => {
          const s = document.getElementById("restaurant");
          s.innerHTML = "";
          data.forEach(v => { if(v) s.innerHTML += `<option value="${v}">${v}</option>`; });
        });
    }

    async function sendData() {
      const btn = document.getElementById("btn");
      const status = document.getElementById("status");
      const data = {
        date: document.getElementById("orderDate").value,
        store: document.getElementById("restaurant").value,
        acc: document.getElementById("acc").value,
        pwd: document.getElementById("pwd").value
      };
      if(!data.acc || !data.pwd) { alert("è«‹è¼¸å…¥ç®¡ç†å¸³å¯†"); return; }
      btn.disabled = true; status.innerText = "æ­£åœ¨å„²å­˜...";
      try {
        const url = `${GAS_SET_URL}?action=submit&date=${data.date}&store=${data.store}&acc=${data.acc}&pwd=${data.pwd}`;
        const res = await fetch(url);
        const text = await res.text();
        status.innerText = text;
        status.style.color = text.includes("æˆåŠŸ") ? "green" : "red";
      } catch (e) { status.innerText = "é€£ç·šå¤±æ•—"; }
      btn.disabled = false;
    }

    function showLoading(show, text) {
      document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
      if(text) document.getElementById("loadingText").innerText = text;
    }

    // åˆå§‹åŒ–è¼‰å…¥
    window.onload = () => {
      loadQueryData();
      loadSettings();
      // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
      document.getElementById('orderDate').valueAsDate = new Date();
    };
  </script>
</body>
</html>
