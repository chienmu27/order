<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨‚é¤ç®¡ç†ç³»çµ±</title>
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%);
      --btn-blue: #1e88ff;
      --btn-red: #d32f2f;
      --card-bg: rgba(255, 255, 255, 0.9);
      --shadow: 0 12px 30px rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft JhengHei", system-ui, sans-serif;
      margin: 0; padding: 20px 10px;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex; justify-content: center;
    }

    .wrap { width: min(1000px, 100%); }

    /* æ¨™é¡Œæ¨£å¼ */
    .title-container { text-align: center; margin-bottom: 20px; }
    h1 {
      background: var(--primary-color); color: white;
      padding: 12px 30px; border-radius: 50px;
      display: inline-flex; align-items: center; gap: 12px;
      font-size: clamp(18px, 5vw, 26px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      margin: 10px 0;
    }

    /* å°è¦½æŒ‰éˆ• */
    .nav-buttons { 
      display: flex; justify-content: center; gap: 10px; 
      margin-bottom: 20px; flex-wrap: wrap; 
    }
    .btn {
      padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer;
      border: none; color: white; border-radius: 50px;
      background: linear-gradient(180deg, var(--btn-blue) 0%, #1565c0 100%);
      transition: 0.3s; min-width: 100px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
    .btn.active { background: #0d47a1; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }

    /* å€å¡Šè¨­å®š */
    .section {
      display: none; background: var(--card-bg);
      padding: 20px; border-radius: 20px; box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    .active-section { display: block; }

    /* ğŸ”¥ è¡¨å–®å…§åµŒå„ªåŒ–ï¼šè®“æ‰‹æ©Ÿæ»‘å‹•é †æš¢ */
    .form-container {
      width: 100%;
      overflow: hidden; /* é˜²æ­¢ç”¢ç”Ÿå…§éƒ¨çš„æ²è»¸ */
    }
    iframe { 
      width: 100%; 
      height: 1600px; /* è¨­å®šè¶³å¤ çš„é«˜åº¦ï¼Œé¿å…å…§éƒ¨æ²è»¸å‡ºç¾ */
      border: none; 
      border-radius: 12px; 
      background: white; 
    }

    /* æŸ¥è©¢é æ¨£å¼ */
    .controls {
      display: flex; flex-wrap: wrap; gap: 15px;
      justify-content: center; padding: 15px;
      background: #fff; border-radius: 15px; margin-bottom: 20px;
    }
    select {
      padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px;
    }

    /* è¡¨æ ¼æ¨£å¼ */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
    th { background: #f8f9fa; color: #555; }
    .total-row { font-weight: bold; background: #e3f2fd !important; }

    /* åˆªé™¤é æŒ‰éˆ• */
    .btn-del-action {
      background: #fff0f0; color: var(--btn-red);
      border: 1px solid #ffcccc; padding: 6px 12px;
      border-radius: 10px; cursor: pointer; font-weight: 800;
    }
    .btn-danger-all { background: var(--btn-red); margin-left: 10px; }

    /* è¨­å®šé å¡ç‰‡ */
    .settings-card { max-width: 400px; margin: 0 auto; }
    .field { margin-bottom: 15px; text-align: left; }
    .field label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .field input, .field select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }

    /* è¼‰å…¥èˆ‡å½ˆçª— */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: none; flex-direction: column; justify-content: center; align-items: center;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    #modalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 3000;
      display: none; justify-content: center; align-items: center;
    }
    .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="title-container">
      <h1>ğŸ± è¨‚é¤ç®¡ç†ç³»çµ±</h1>
    </div>

    <div class="nav-buttons">
      <button class="btn active" onclick="showSection('form-section', this)">ğŸ“ å¡«å¯«è¨‚å–®</button>
      <button class="btn" onclick="showSection('query-section', this)">ğŸ” æŸ¥è©¢çµ±è¨ˆ</button>
      <button class="btn" onclick="showSection('delete-section', this)">ğŸ—‘ï¸ è¨‚å–®ç®¡ç†</button>
      <button class="btn" onclick="showSection('settings-section', this)">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>

    <div id="form-section" class="section active-section">
      <div class="form-container">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?embedded=true" scrolling="no">è¼‰å…¥ä¸­â€¦</iframe>
      </div>
    </div>

    <div id="query-section" class="section">
      <h3 id="sheetTitle" style="text-align:center;">è¨‚å–®æŸ¥è©¢ç³»çµ±</h3>
      <div class="controls">
        <select id="buyerSelect"><option value="">--é¸æ“‡è¨‚è³¼äºº--</option></select>
        <select id="listSelect">
          <option value="">--çµ±è¨ˆè¡¨--</option>
          <option value="list1">äººå“¡ / é‡‘é¡çµ±è¨ˆ</option>
          <option value="list2">å“é … / æ•¸é‡çµ±è¨ˆ</option>
        </select>
      </div>
      <div class="table-responsive">
        <table id="resultTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="delete-section" class="section">
      <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin:0;">ğŸ“‹ è¨‚å–®æ¸…å–®</h3>
        <div>
          <button class="btn" style="min-width:auto; padding:5px 15px;" onclick="fetchOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
          <button class="btn btn-danger-all" onclick="prepareDelete('all')">ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤</button>
        </div>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>æ™‚é–“</th><th>äººå“¡</th><th>å“é …</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="settings-section" class="section">
      <div class="settings-card">
        <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
        <div class="field">
          <label>è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2026-02-13">
        </div>
        <div class="field">
          <label>é¸æ“‡åº—å®¶</label>
          <select id="restaurant"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <hr>
        <div class="field">
          <label>ç®¡ç†å¸³è™Ÿ</label>
          <input type="text" id="acc" placeholder="è¼¸å…¥å¸³è™Ÿ">
        </div>
        <div class="field">
          <label>ç®¡ç†å¯†ç¢¼</label>
          <input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼">
        </div>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="sendData()" id="btnSubmitSetting">å„²å­˜è¨­å®š</button>
        <div id="status" style="margin-top:10px; text-align:center;"></div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="margin-top:15px; color:#555; font-weight:bold;">è™•ç†ä¸­...</div>
  </div>

  <div id="modalOverlay">
    <div class="modal-box">
      <h3 id="modalTitle">å®‰å…¨é©—è­‰</h3>
      <p id="modalDesc" style="color:#666; font-size:14px;">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼åŸ·è¡Œåˆªé™¤</p>
      <input type="password" id="pwdInput" style="width:100%; padding:10px; margin:15px 0; border-radius:10px; border:1px solid #ddd;">
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#ccc; flex:1;" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn" style="background:var(--btn-red); flex:1;" id="btnConfirm">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    const QUERY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
    const DELETE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
    const GAS_DELETE_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
    const GAS_SETTING_URL = "https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec";

    function showSection(id, btn) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
      document.querySelectorAll(".nav-buttons .btn").forEach(b => b.classList.remove("active"));
      document.getElementById(id).classList.add("active-section");
      btn.classList.add("active");
      if(id === 'delete-section') fetchOrders();
      window.scrollTo(0,0);
    }

    // --- å…±é€šè§£æ CSV ---
    function parseCSV(text) {
      const result = [];
      let cur = [], curVal = "", inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i], next = text[i+1];
        if (inQuotes) {
          if (ch === '"' && next === '"') { curVal += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else curVal += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { cur.push(curVal); curVal = ""; }
          else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
          else if (ch !== '\r') curVal += ch;
        }
      }
      if (curVal !== "" || cur.length > 0) { cur.push(curVal); result.push(cur); }
      return result;
    }

    // --- æŸ¥è©¢åŠŸèƒ½ ---
    let queryData = [];
    async function loadQueryData() {
      try {
        const res = await fetch(QUERY_CSV);
        const text = await res.text();
        const rows = parseCSV(text).filter(r => r.some(c => c.trim() !== ""));
        if(rows.length > 1) {
          document.getElementById("sheetTitle").innerText = rows[1][2] + " è¨‚å–®æŸ¥è©¢";
          queryHeader = rows[1];
          queryData = rows.slice(2);
          const buyers = [...new Set(queryData.map(r => r[queryHeader.indexOf("è³¼è²·äºº")]))].sort();
          const select = document.getElementById("buyerSelect");
          buyers.forEach(b => { if(b){ let opt = new Option(b, b); select.add(opt); }});
        }
      } catch (e) { console.error("æŸ¥è©¢è³‡æ–™è¼‰å…¥å¤±æ•—"); }
    }

    document.getElementById("buyerSelect").onchange = function() {
      document.getElementById("listSelect").value = "";
      renderTable(this.value);
    };

    document.getElementById("listSelect").onchange = function() {
      document.getElementById("buyerSelect").value = "";
      if(this.value === 'list1') renderSummary('buyer');
      if(this.value === 'list2') renderSummary('item');
    };

    function renderTable(name) {
      const tbody = document.querySelector("#resultTable tbody");
      const thead = document.querySelector("#resultTable thead");
      thead.innerHTML = `<tr><th>å“é …</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>`;
      tbody.innerHTML = "";
      let total = 0;
      queryData.filter(r => r[queryHeader.indexOf("è³¼è²·äºº")] === name).forEach(r => {
        const sub = parseInt(r[queryHeader.indexOf("å°è¨ˆ")]) || 0;
        total += sub;
        tbody.innerHTML += `<tr><td>${r[queryHeader.indexOf("é …ç›®")]}</td><td>${r[queryHeader.indexOf("å–®åƒ¹")]}</td><td>${r[queryHeader.indexOf("æ•¸é‡")]}</td><td>${sub}</td></tr>`;
      });
      tbody.innerHTML += `<tr class="total-row"><td colspan="3">å€‹äººç¸½è¨ˆ</td><td>${total}</td></tr>`;
    }

    function renderSummary(mode) {
      const tbody = document.querySelector("#resultTable tbody");
      const thead = document.querySelector("#resultTable thead");
      const isBuyer = mode === 'buyer';
      thead.innerHTML = `<tr><th>${isBuyer?'è³¼è²·äºº':'å“é …'}</th><th>${isBuyer?'ç¸½é‡‘é¡':'ç¸½æ•¸é‡'}</th></tr>`;
      tbody.innerHTML = "";
      let grandTotal = 0;
      const map = {};
      const keyIdx = queryHeader.indexOf(isBuyer ? "è³¼è²·äºº" : "é …ç›®");
      const valIdx = queryHeader.indexOf(isBuyer ? "å°è¨ˆ" : "æ•¸é‡");
      
      queryData.forEach(r => {
        const k = r[keyIdx], v = parseInt(r[valIdx]) || 0;
        if(k) map[k] = (map[k] || 0) + v;
      });
      
      Object.keys(map).sort().forEach(k => {
        grandTotal += map[k];
        tbody.innerHTML += `<tr><td>${k}</td><td>${map[k]}</td></tr>`;
      });
      tbody.innerHTML += `<tr class="total-row"><td>å…¨é«”ç¸½è¨ˆ</td><td>${grandTotal}</td></tr>`;
    }

    // --- åˆªé™¤åŠŸèƒ½ ---
    async function fetchOrders() {
      showLoading(true, "è®€å–æœ€æ–°è¨‚å–®...");
      try {
        const res = await fetch(DELETE_CSV + "&t=" + Date.now());
        const text = await res.text();
        const rows = parseCSV(text).slice(1);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = rows.map((r, i) => r[1] ? `
          <tr>
            <td>${r[0].split(" ")[0]}</td>
            <td>${r[1]}</td>
            <td>${r[2]}</td>
            <td>${r[3]}</td>
            <td style="font-size:12px; color:#777;">${r[4]||""}</td>
            <td><button class="btn-del-action" onclick="prepareDelete(${i+2})">åˆªé™¤</button></td>
          </tr>` : "").join("");
      } catch (e) { alert("è®€å–æ¸…å–®å¤±æ•—"); }
      finally { showLoading(false); }
    }

    let targetRow = null;
    function prepareDelete(row) {
      targetRow = row;
      document.getElementById("modalOverlay").style.display = "flex";
      document.getElementById("modalDesc").innerText = row === 'all' ? "è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºç•¶å‰æ‰€æœ‰è¨‚å–®ï¼" : "è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼åŸ·è¡Œå–®ç­†åˆªé™¤";
    }

    function closeModal() { document.getElementById("modalOverlay").style.display = "none"; }

    document.getElementById("btnConfirm").onclick = async function() {
      const pwd = document.getElementById("pwdInput").value;
      if(!pwd) return;
      closeModal();
      showLoading(true, "åŸ·è¡Œåˆªé™¤ä¸­...");
      try {
        const res = await fetch(GAS_DELETE_URL, {
          method: 'POST',
          body: JSON.stringify({ row: targetRow, password: pwd })
        });
        const result = await res.json();
        alert(result.message);
        if(result.status === 'success') fetchOrders();
      } catch (e) { alert("é€£ç·šå¤±æ•—"); }
      finally { showLoading(false); }
    };

    // --- è¨­å®šåŠŸèƒ½ ---
    async function loadSettings() {
      try {
        const res = await fetch(GAS_SETTING_URL + "?action=getOptions");
        const data = await res.json();
        const select = document.getElementById("restaurant");
        select.innerHTML = data.map(i => `<option value="${i}">${i}</option>`).join("");
      } catch (e) { console.error("è¨­å®šé¸å–®è¼‰å…¥å¤±æ•—"); }
    }

    async function sendData() {
      const btn = document.getElementById("btnSubmitSetting");
      const status = document.getElementById("status");
      const payload = {
        date: document.getElementById("orderDate").value,
        store: document.getElementById("restaurant").value,
        acc: document.getElementById("acc").value,
        pwd: document.getElementById("pwd").value
      };
      if(!payload.acc || !payload.pwd) { alert("è«‹è¼¸å…¥å¸³å¯†"); return; }
      
      btn.disabled = true;
      status.innerText = "å‚³é€ä¸­...";
      try {
        const url = `${GAS_SETTING_URL}?action=submit&date=${payload.date}&store=${encodeURIComponent(payload.store)}&acc=${payload.acc}&pwd=${payload.pwd}`;
        const res = await fetch(url);
        const txt = await res.text();
        status.innerText = txt;
        status.style.color = txt.includes("æˆåŠŸ") ? "green" : "red";
      } catch (e) { status.innerText = "ç³»çµ±é€£ç·šéŒ¯èª¤"; }
      finally { btn.disabled = false; }
    }

    function showLoading(show, txt) {
      document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
      if(txt) document.getElementById("loadingText").innerText = txt;
    }

    // åˆå§‹åŒ–
    loadQueryData();
    loadSettings();
  </script>
</body>
</html>
