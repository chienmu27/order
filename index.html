<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¨‚é¤ç³»çµ±ï¼ˆå¡«å–® / æŸ¥è©¢ / åˆªé™¤ / è¨­å®šï¼‰</title>

  <style>
    :root {
      --primary: #4285f4;
      --danger: #dc3545;
      --bg: #f8f9fa;
      --card: #fff;
      --text: #333;
      --muted: #666;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* å…§å®¹å€ */
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 18px 14px 60px;
    }

    /* ğŸ”¥ æ”¹æˆä¸€èˆ¬é é¢å…§çš„é¸å–®å€ï¼ˆä¸å†æ˜¯æ©«å¹…æ¡†æ¶ï¼‰ */
    .menu-bar {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 14px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 18px;
    }

    .brand .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }

    .nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav button {
      border: 1px solid var(--border);
      background: white;
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: 0.2s;
    }

    .nav button:hover {
      border-color: #cfd6e3;
      transform: translateY(-1px);
    }

    .nav button.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 18px;
    }

    /* å…±ç”¨æ¨™é¡Œ */
    .page-title {
      margin: 0 0 14px;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 0.4px;
    }

    .hint {
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    /* è¡¨å–® iframe */
    .form-frame {
      width: 100%;
      height: 850px;
      border: 0;
      border-radius: 14px;
      background: #fff;
    }

    /* æŸ¥è©¢é æ¨£å¼ï¼ˆä¿ç•™ä½ çš„é¢¨æ ¼ï¼‰ */
    #queryPage body { background: transparent; }
    #queryPage h2 { color: #333; text-align: center; margin: 0 0 14px; }
    #queryPage .controls {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      align-items: center;
    }
    #queryPage label { font-weight: bold; margin-right: 5px; }
    #queryPage select {
      font-size: 16px;
      padding: 8px;
      width: 220px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
    }
    #queryPage table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      overflow: hidden;
      border-radius: 10px;
    }
    #queryPage th, #queryPage td {
      border: 1px solid #e5e5e5;
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    #queryPage th { background-color: #f8f9fa; color: #555; }
    #queryPage tr:nth-child(even) { background-color: #fcfcfc; }
    #queryPage .total-row { font-weight: bold; background: #e9ecef !important; }

    /* åˆªé™¤é æ¨£å¼ï¼ˆä¿ç•™ä½ çš„é¢¨æ ¼ï¼‰ */
    #deletePage .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    #deletePage .header-btns { display: flex; gap: 8px; }
    #deletePage .refresh-btn {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
    }
    #deletePage .del-all-btn {
      background: white;
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 800;
    }
    #deletePage .del-all-btn:hover { background: var(--danger); color: white; }
    #deletePage .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    #deletePage table { width: 100%; border-collapse: collapse; min-width: 720px; font-size: 14px; }
    #deletePage th, #deletePage td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
    #deletePage th { background: #f8f9fa; color: #666; font-weight: bold; }
    #deletePage tr:hover { background: #fcfcfc; }
    #deletePage .btn-del {
      background: #fff0f0;
      color: var(--danger);
      border: 1px solid #ffcccc;
      padding: 6px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 800;
    }
    #deletePage .btn-del:hover { background: var(--danger); color: white; }

    /* åˆªé™¤é è¼‰å…¥é®ç½© */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: none;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* åˆªé™¤é å¯†ç¢¼å½ˆçª— */
    #modalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 3000;
      display: none; justify-content: center; align-items: center;
    }
    #modalBox {
      background: #fff; padding: 25px; border-radius: 14px; width: 90%; max-width: 340px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
      border: 1px solid #eee;
    }
    #pwdInput {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 16px;
    }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns button {
      flex: 1; padding: 10px;
      border: none; border-radius: 10px;
      cursor: pointer; font-weight: bold;
    }
    #btnConfirm { background: var(--primary); color: #fff; }
    #btnCancel { background: #eee; color: #333; }

    /* è¨­å®šé ï¼ˆä¿ç•™ä½ çš„å¡ç‰‡é¢¨æ ¼ï¼‰ */
    #settingsPage .settings-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 380px;
      margin: auto;
      border: 1px solid #eee;
    }
    #settingsPage h3 { margin-top: 0; color: #333; text-align: center; }
    #settingsPage .field { margin-bottom: 15px; }
    #settingsPage label {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
      color: #666;
      font-weight: bold;
    }
    #settingsPage input, #settingsPage select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 14px;
    }
    #settingsPage button {
      width: 100%;
      padding: 12px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: 0.3s;
    }
    #settingsPage button:hover { background: #357abd; }
    #settingsPage button:disabled { background: #ccc; }
    #settingsPage #status {
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
      min-height: 20px;
    }
    #settingsPage .success { color: #28a745; font-weight: 800; }
    #settingsPage .error { color: #dc3545; font-weight: 800; }

  </style>
</head>

<body>

  <div class="container">

    <!-- âœ… è®Šæˆé é¢å…§é¸å–®ï¼Œä¸å†æ˜¯æ©«å¹…æ¡†æ¶ -->
    <div class="menu-bar">
      <div class="brand">
        <span class="dot"></span>
        <span>è¨‚é¤ç³»çµ±</span>
      </div>

      <div class="nav">
        <button class="active" data-page="formPage">ğŸ“ å¡«å–®</button>
        <button data-page="queryPage">ğŸ” æŸ¥è©¢</button>
        <button data-page="deletePage">ğŸ—‘ï¸ åˆªé™¤</button>
        <button data-page="settingsPage">âš™ï¸ è¨­å®š</button>
      </div>
    </div>

    <!-- 1) å¡«å–® -->
    <section id="formPage" class="page active">
      <div class="card">

        <iframe
          class="form-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?usp=header"
          loading="lazy"
        ></iframe>
      </div>
    </section>

    <!-- 2) æŸ¥è©¢ -->
    <section id="queryPage" class="page">
      <div class="card">
        <h2 id="sheetTitle">è¨‚å–®æŸ¥è©¢ç³»çµ±</h2>

        <div class="controls">
          <div>
            <label>è¨‚è³¼äººå“¡ï¼š</label>
            <select id="buyerSelect">
              <option value="">--è«‹é¸æ“‡--</option>
            </select>
          </div>

          <div>
            <label>è¨‚å–®çµ±è¨ˆï¼š</label>
            <select id="listSelect">
              <option value="">--è«‹é¸æ“‡--</option>
              <option value="list1">è³¼è²·äºº / é‡‘é¡ç¸½è¨ˆ</option>
              <option value="list2">é …ç›® / è¨‚è³¼æ•¸é‡ç¸½è¨ˆ</option>
            </select>
          </div>
        </div>

        <table id="resultTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 3) åˆªé™¤ -->
    <section id="deletePage" class="page">
      <div class="card">

        <div class="header">
          <h3 style="margin:0;">ğŸ“‹ è¨‚å–®ç®¡ç†æ¸…å–®</h3>
          <div class="header-btns">
            <button class="refresh-btn" onclick="fetchOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="del-all-btn" onclick="prepareDelete('all')">ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ™‚é–“</th>
                <th>è¨‚é¤äººå“¡</th>
                <th>ä¾¿ç•¶å“é …</th>
                <th>æ•¸é‡</th>
                <th>å‚™è¨»</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

      </div>
    </section>

    <!-- 4) è¨­å®š -->
    <section id="settingsPage" class="page">
      <div class="settings-card">
        <h3>è¨‚é¤ç®¡ç†ç³»çµ±</h3>

        <div class="field">
          <label>è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2026-01-26">
        </div>

        <div class="field">
          <label>åº—å®¶é¸å–®</label>
          <select id="restaurant">
            <option>è¼‰å…¥ä¸­...</option>
          </select>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="field">
          <label>å¸³è™Ÿ</label>
          <input type="text" id="acc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
        </div>

        <div class="field">
          <label>å¯†ç¢¼</label>
          <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>

        <button onclick="sendData()" id="btn">é€å‡ºè¨­å®š</button>
        <div id="status"></div>
      </div>
    </section>

  </div>

  <!-- åˆªé™¤é ï¼šè¼‰å…¥å‹•ç•« -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="margin-top:15px; color:#555;">æ­£åœ¨å–å¾—è¨‚å–®è³‡æ–™...</div>
  </div>

  <!-- åˆªé™¤é ï¼šå¯†ç¢¼å½ˆçª— -->
  <div id="modalOverlay">
    <div id="modalBox">
      <h3 id="modalTitle" style="margin-top:0;">èº«åˆ†é©—è­‰</h3>
      <p id="modalDesc" style="color:#666; font-size:14px;">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥åŸ·è¡Œåˆªé™¤</p>
      <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      <div class="modal-btns">
        <button id="btnCancel">å–æ¶ˆ</button>
        <button id="btnConfirm">ç¢ºèªåŸ·è¡Œ</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   A) é é¢åˆ‡æ›ï¼ˆæŒ‰éˆ•ï¼‰
========================= */
(function initNav(){
  const navButtons = document.querySelectorAll(".nav button");
  const pages = document.querySelectorAll(".page");

  function showPage(id){
    pages.forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    navButtons.forEach(b => b.classList.remove("active"));
    document.querySelector(`.nav button[data-page="${id}"]`).classList.add("active");

    if(id === "deletePage"){
      fetchOrders();
    }
  }

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => showPage(btn.dataset.page));
  });
})();


/* =========================
   B) è¨‚é¤æŸ¥è©¢ï¼ˆåŸåŠŸèƒ½ä¿ç•™ + ä¿®æ­£å­—ä¸²éŒ¯èª¤ï¼‰
========================= */

const queryCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";

let queryRows = [];
let queryHeader = [];
let queryDataRows = [];

function parseCSV(text) {
  const result = [];
  let cur = [];
  let curVal = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];

    if (inQuotes) {
      if (ch === '"' && next === '"') { curVal += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else curVal += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { cur.push(curVal); curVal = ""; }
      else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
      else if (ch !== '\r') curVal += ch;
    }
  }

  if (curVal !== "" || cur.length > 0) {
    cur.push(curVal);
    result.push(cur);
  }
  return result;
}

async function loadQueryCSV() {
  try {
    const res = await fetch(queryCsvUrl);
    const text = await res.text();
    const parsed = parseCSV(text);

    queryRows = parsed.filter(r => r.some(c => (c ?? "").trim() !== ""));

    if (queryRows.length > 1) {
      const titleInfo = queryRows[0];
      document.getElementById("sheetTitle").innerText =
        (titleInfo[2] || "è¨‚å–®æŸ¥è©¢") + " (" + (titleInfo[0] || "") + ")";

      queryHeader = queryRows[1];
      queryDataRows = queryRows.slice(2);

      buildBuyerDropdown();
    }
  } catch (e) {
    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª CSV é€£çµæ˜¯å¦æ­£ç¢ºä¸¦å·²ç™¼å¸ƒã€‚");
  }
}

function buildBuyerDropdown() {
  const buyerIdx = queryHeader.indexOf("è³¼è²·äºº");
  if (buyerIdx === -1) {
    alert("æ‰¾ä¸åˆ°ã€Œè³¼è²·äººã€æ¬„ä½ï¼Œè«‹æª¢æŸ¥å·¥ä½œè¡¨æ¨™é¡Œæ˜¯å¦ä½æ–¼ç¬¬äºŒåˆ—ã€‚");
    return;
  }

  const set = new Set();
  queryDataRows.forEach(r => {
    const val = (r[buyerIdx] ?? "").trim();
    if (val && val !== "è³¼è²·äºº") set.add(val);
  });

  const select = document.getElementById("buyerSelect");
  select.innerHTML = `
    <option value="">--è«‹é¸æ“‡--</option>
    <option value="ALL">å…¨éƒ¨è¨‚å–®æ¸…å–®</option>
  `;

  [...set].sort().forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    select.appendChild(op);
  });
}

function renderNormalTable(buyer) {
  const thead = document.querySelector("#resultTable thead");
  const tbody = document.querySelector("#resultTable tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  const idxItem = queryHeader.indexOf("é …ç›®");
  const idxPrice = queryHeader.indexOf("å–®åƒ¹");

  const idxQty = queryHeader.indexOf("æ•¸é‡");
  const idxSub = queryHeader.indexOf("å°è¨ˆ");
  const idxBuyer = queryHeader.indexOf("è³¼è²·äºº");

  thead.innerHTML = `
    <tr>
      <th>è³¼è²·äºº</th>
      <th>é …ç›®</th>
      <th>å–®åƒ¹</th>

      <th>æ•¸é‡</th>
      <th>å°è¨ˆ</th>
    </tr>
  `;

  let filtered = buyer === "ALL"
    ? queryDataRows
    : queryDataRows.filter(r => (r[idxBuyer] ?? "").trim() === buyer);

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7">æ²’æœ‰æŸ¥è©¢åˆ°è³‡æ–™</td></tr>`;
    return;
  }

  let totalSum = 0;

  filtered.forEach(r => {
    const subTotal = Number(r[idxSub]) || 0;
    totalSum += subTotal;

    tbody.innerHTML += `
      <tr>
        <td>${r[idxBuyer] ?? ""}</td>
        <td>${r[idxItem] ?? ""}</td>
        <td>${r[idxPrice] ?? ""}</td>
        <td>${r[idxRice] ?? ""}</td>
        <td>${r[idxAdd] ?? ""}</td>
        <td>${r[idxQty] ?? ""}</td>
        <td>${subTotal}</td>
      </tr>
    `;
  });

  if (buyer !== "ALL") {
    tbody.innerHTML += `
      <tr class="total-row">
        <td colspan="6">å€‹äººåˆè¨ˆ</td>
        <td>${totalSum}</td>
      </tr>
    `;
  }
}

function renderList1() {
  const idxBuyer = queryHeader.indexOf("è³¼è²·äºº");
  const idxSub = queryHeader.indexOf("å°è¨ˆ");

  const thead = document.querySelector("#resultTable thead");
  const tbody = document.querySelector("#resultTable tbody");

  thead.innerHTML = `<tr><th>è³¼è²·äºº</th><th>é‡‘é¡ç¸½è¨ˆ</th></tr>`;
  tbody.innerHTML = "";

  const summary = {};
  queryDataRows.forEach(r => {
    const name = (r[idxBuyer] ?? "").trim();
    const amt = Number(r[idxSub]) || 0;
    if (name) summary[name] = (summary[name] || 0) + amt;
  });

  let grandTotal = 0;
  Object.keys(summary).sort().forEach(name => {
    grandTotal += summary[name];
    tbody.innerHTML += `<tr><td>${name}</td><td>${summary[name]}</td></tr>`;
  });

  tbody.innerHTML += `<tr class="total-row"><td>å…¨é«”ç¸½è¨ˆ</td><td>${grandTotal}</td></tr>`;
}

function renderList2() {
  const idxItem = queryHeader.indexOf("é …ç›®");
  const idxQty = queryHeader.indexOf("æ•¸é‡");

  const thead = document.querySelector("#resultTable thead");
  const tbody = document.querySelector("#resultTable tbody");

  thead.innerHTML = `<tr><th>é …ç›®</th><th>è¨‚è³¼æ•¸é‡ç¸½è¨ˆ</th></tr>`;
  tbody.innerHTML = "";

  const summary = {};
  queryDataRows.forEach(r => {
    const item = (r[idxItem] ?? "").trim();
    const qty = Number(r[idxQty]) || 0;
    if (item) summary[item] = (summary[item] || 0) + qty;
  });

  let grandQty = 0;
  Object.keys(summary).sort().forEach(item => {
    grandQty += summary[item];
    tbody.innerHTML += `<tr><td>${item}</td><td>${summary[item]}</td></tr>`;
  });

  tbody.innerHTML += `<tr class="total-row"><td>ç¸½æ•¸é‡</td><td>${grandQty}</td></tr>`;
}

document.getElementById("buyerSelect").addEventListener("change", (e) => {
  document.getElementById("listSelect").value = "";
  if (e.target.value) renderNormalTable(e.target.value);
});

document.getElementById("listSelect").addEventListener("change", (e) => {
  document.getElementById("buyerSelect").value = "";
  const opt = e.target.value;
  if (opt === "list1") renderList1();
  else if (opt === "list2") renderList2();
});

loadQueryCSV();


/* =========================
   C) è¨‚é¤åˆªé™¤ï¼ˆåŸåŠŸèƒ½ä¿ç•™ + ä¿®æ­£ fetch/å­—ä¸²éŒ¯èª¤ï¼‰
========================= */

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
let targetRow = null;

async function fetchOrders() {
  showLoading(true, "æ›´æ–°æ¸…å–®ä¸­...");
  try {
    const res = await fetch(`${CSV_URL}&t=${new Date().getTime()}`);
    const text = await res.text();
    const rows = parseCSV(text);
    renderDeleteTable(rows);
  } catch (err) {
    alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ– CSV é€£çµ");
  } finally {
    showLoading(false);
  }
}

function renderDeleteTable(rows) {
  const tbody = document.getElementById('tableBody');

  if (!rows || rows.length < 2) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; color:#999;">ç›®å‰å°šç„¡è¨‚å–®</td></tr>';
    return;
  }

  const header = rows[0];
  const data = rows.slice(1);

  const idxTime = header.indexOf("æ™‚é–“æˆ³è¨˜");
  const idxUser = header.indexOf("è¨‚é¤äººå“¡");
  const idxItem = header.indexOf("ä¾¿ç•¶å“é …");
  const idxQty = header.indexOf("æ•¸é‡");
  const idxNote = header.indexOf("å‚™è¨»");

  tbody.innerHTML = data.map((row, i) => {
    if (!row[idxUser]) return '';

    const sheetRow = i + 2;

    let time = row[idxTime] || "";
    if (time.includes("/")) {
      const parts = time.split(" ");
      const d = parts[0].split("/").slice(1).join("/");
      const t = (parts[1] || "").substring(0,5);
      time = `${d} ${t}`;
    }

    return `
      <tr>
        <td>${time}</td>
        <td>${row[idxUser] ?? ""}</td>
        <td>${row[idxItem] ?? ""}</td>
        <td>${row[idxQty] ?? ""}</td>
        <td style="color:#666; font-size:12px;">${row[idxNote] ?? ""}</td>
        <td><button class="btn-del" onclick="prepareDelete(${sheetRow})">åˆªé™¤</button></td>
      </tr>
    `;
  }).join('');
}

function prepareDelete(row) {
  targetRow = row;

  const desc = document.getElementById('modalDesc');
  if (row === 'all') {
    desc.innerHTML = "<b style='color:red'>è­¦å‘Šï¼šå³å°‡åˆªé™¤æ‰€æœ‰è¨‚å–®è³‡æ–™ï¼</b><br>è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªï¼š";
  } else {
    desc.innerText = "è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥åŸ·è¡Œå–®ç­†åˆªé™¤";
  }

  document.getElementById('pwdInput').value = "";
  document.getElementById('modalOverlay').style.display = 'flex';
  document.getElementById('pwdInput').focus();
}

document.getElementById('btnCancel').onclick = () => {
  document.getElementById('modalOverlay').style.display = 'none';
};

document.getElementById('btnConfirm').onclick = async () => {
  const password = document.getElementById('pwdInput').value;
  if (!password) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }

  document.getElementById('modalOverlay').style.display = 'none';

  showLoading(true, targetRow === 'all'
    ? "æ­£åœ¨æ¸…ç©ºæ‰€æœ‰è¨‚å–®..."
    : "æ­£åœ¨åŸ·è¡Œå–®ç­†åˆªé™¤..."
  );

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ row: targetRow, password: password })
    });

    const result = await res.json();
    alert(result.message);

    if (result.status === 'success') {
      fetchOrders();
    }
  } catch (err) {
    alert("ä¼ºæœå™¨é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  } finally {
    showLoading(false);
  }
};

function showLoading(show, text) {
  const el = document.getElementById('loadingOverlay');
  const txt = document.getElementById('loadingText');

  if (show) {
    el.style.display = 'flex';
    if (text) txt.innerText = text;
  } else {
    el.style.display = 'none';
  }
}


/* =========================
   D) è¨­å®šé ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰
========================= */

const scriptUrl = 'https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec';

function loadSettingsOptions() {
  fetch(scriptUrl + "?action=getOptions")
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById('restaurant');
      select.innerHTML = '';
      data.forEach(item => {
        if(item) {
          let opt = document.createElement('option');
          opt.value = item;
          opt.innerHTML = item;
          select.appendChild(opt);
        }
      });
    })
    .catch(err => {
      document.getElementById('status').innerHTML = "é¸å–®è¼‰å…¥å¤±æ•—";
      document.getElementById('status').className = "error";
    });
}

loadSettingsOptions();

function sendData() {
  const btn = document.getElementById('btn');
  const status = document.getElementById('status');

  const date = document.getElementById('orderDate').value;
  const store = document.getElementById('restaurant').value;
  const acc = document.getElementById('acc').value;
  const pwd = document.getElementById('pwd').value;

  if (!acc || !pwd || !date || !store) {
    alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
    return;
  }

  btn.disabled = true;
  status.className = "";
  status.innerHTML = "è™•ç†ä¸­...";

  const finalUrl =
    `${scriptUrl}?action=submit&date=${encodeURIComponent(date)}&store=${encodeURIComponent(store)}&acc=${encodeURIComponent(acc)}&pwd=${encodeURIComponent(pwd)}`;

  fetch(finalUrl)
    .then(res => res.text())
    .then(text => {
      status.innerHTML = text;
      status.className = text.includes("æˆåŠŸ") ? "success" : "error";
      btn.disabled = false;

      if(text.includes("æˆåŠŸ")) {
        document.getElementById('acc').value = "";
        document.getElementById('pwd').value = "";
      }
    })
    .catch(err => {
      status.innerHTML = "é€£ç·šç™¼ç”ŸéŒ¯èª¤";
      status.className = "error";
      btn.disabled = false;
    });
}
</script>

</body>
</html>
