<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨‚é¤ç®¡ç†ç³»çµ±</title>
  <style>
    :root {
      --primary-color: #4285f4;
      --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --btn-blue: linear-gradient(180deg, #1e88ff 0%, #1565c0 100%);
      --btn-red: linear-gradient(180deg, #ff5252 0%, #d32f2f 100%);
      --shadow: 0 12px 30px rgba(0,0,0,0.1);
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft JhengHei", system-ui, sans-serif;
      margin: 0; padding: 20px 10px;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex; justify-content: center;
    }

    .wrap { width: min(1000px, 100%); }

    /* æ¨™é¡Œèˆ‡å°è¦½ */
    .header-area { text-align: center; margin-bottom: 20px; }
    h1 {
      background: var(--primary-color); color: white;
      padding: 10px 25px; border-radius: 50px;
      display: inline-flex; align-items: center; gap: 10px;
      font-size: clamp(18px, 5vw, 24px);
      box-shadow: var(--shadow);
    }

    .nav-buttons {
      display: flex; justify-content: center; gap: 8px;
      margin-bottom: 20px; flex-wrap: wrap;
    }

    .btn-nav {
      padding: 10px 18px; font-size: 15px; font-weight: bold; cursor: pointer;
      border: none; color: white; border-radius: 50px;
      background: var(--btn-blue);
      transition: 0.3s; opacity: 0.7;
    }
    .btn-nav.active { opacity: 1; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    /* å…§å®¹å€å¡Š */
    .section {
      display: none; background: var(--card-bg);
      padding: 20px; border-radius: 20px; box-shadow: var(--shadow);
      animation: fadeIn 0.4s ease;
    }
    .section.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* è¡¨å–®é é¢å°ˆç”¨å„ªåŒ– */
    #form-section { padding: 0; overflow: hidden; }
    .iframe-container { width: 100%; height: 80vh; -webkit-overflow-scrolling: touch; overflow-y: auto; }
    iframe { width: 100%; height: 2000px; border: none; }

    /* æŸ¥è©¢èˆ‡è¡¨æ ¼æ¨£å¼ */
    .controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; justify-content: center; }
    .field-group { display: flex; flex-direction: column; gap: 5px; }
    select, input {
      padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
    }

    .table-responsive { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; font-size: 14px; }
    th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
    th { background: #f8f9fa; font-weight: bold; }
    .total-row { background: #e9ecef; font-weight: bold; }

    /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
    .btn-del {
      background: #fff0f0; color: #dc3545; border: 1px solid #ffcccc;
      padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .btn-del:hover { background: #dc3545; color: white; }

    .btn-action {
      padding: 12px 24px; background: var(--btn-blue); color: white; border: none;
      border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px;
    }

    /* å½ˆçª—èˆ‡é®ç½© */
    #loadingOverlay, #modalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 999;
      display: none; justify-content: center; align-items: center; flex-direction: column;
    }
    .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="header-area">
    <h1>ğŸ± è¨‚é¤ç®¡ç†ç³»çµ±</h1>
  </div>

  <div class="nav-buttons">
    <button class="btn-nav active" onclick="showSection('form-section')">ğŸ“ å¡«å–®</button>
    <button class="btn-nav" onclick="showSection('query-section')">ğŸ” æŸ¥è©¢</button>
    <button class="btn-nav" onclick="showSection('delete-section')">ğŸ—‘ï¸ åˆªé™¤</button>
    <button class="btn-nav" onclick="showSection('settings-section')">âš™ï¸ è¨­å®š</button>
  </div>

  <div id="form-section" class="section active">
    <div class="iframe-container">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?usp=header">è¼‰å…¥ä¸­â€¦</iframe>
    </div>
  </div>

  <div id="query-section" class="section">
    <h3 id="sheetTitle" style="text-align:center;">è¨‚å–®æŸ¥è©¢</h3>
    <div class="controls">
      <div class="field-group">
        <label>è¨‚è³¼äººå“¡</label>
        <select id="buyerSelect"><option value="">--è«‹é¸æ“‡--</option></select>
      </div>
      <div class="field-group">
        <label>çµ±è¨ˆæ–¹å¼</label>
        <select id="listSelect">
          <option value="">--è«‹é¸æ“‡--</option>
          <option value="list1">è³¼è²·äºº / é‡‘é¡ç¸½è¨ˆ</option>
          <option value="list2">é …ç›® / æ•¸é‡ç¸½è¨ˆ</option>
        </select>
      </div>
    </div>
    <div class="table-responsive">
      <table id="resultTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="delete-section" class="section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0;">ğŸ“‹ è¨‚å–®æ¸…å–®</h3>
      <button class="btn-del" onclick="prepareDelete('all')">æ¸…ç©ºå…¨éƒ¨</button>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr><th>æ™‚é–“</th><th>äººå“¡</th><th>å“é …</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <button class="btn-action" onclick="fetchOrders()" style="margin-top:15px;">ğŸ”„ é‡æ–°æ•´ç†æ¸…å–®</button>
  </div>

  <div id="settings-section" class="section">
    <div style="max-width:400px; margin:auto;">
      <h3 style="text-align:center;">ç³»çµ±åƒæ•¸è¨­å®š</h3>
      <div class="field-group" style="margin-bottom:15px;">
        <label>è¨‚é¤æ—¥æœŸ</label>
        <input type="date" id="orderDate" value="2026-01-26">
      </div>
      <div class="field-group" style="margin-bottom:15px;">
        <label>åº—å®¶é¸å–®</label>
        <select id="restaurant"><option>è¼‰å…¥ä¸­...</option></select>
      </div>
      <hr>
      <div class="field-group" style="margin-bottom:15px;">
        <label>ç®¡ç†å¸³è™Ÿ</label>
        <input type="text" id="acc" placeholder="è¼¸å…¥å¸³è™Ÿ">
      </div>
      <div class="field-group" style="margin-bottom:15px;">
        <label>ç®¡ç†å¯†ç¢¼</label>
        <input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn-action" id="btn" onclick="sendData()">é€å‡ºè¨­å®šå…§å®¹</button>
      <div id="status" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
    </div>
  </div>
</div>

<div id="loadingOverlay">
  <div style="color:white;">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
</div>

<div id="modalOverlay">
  <div class="modal-box">
    <h3>èº«åˆ†é©—è­‰</h3>
    <p id="modalDesc">è«‹è¼¸å…¥å¯†ç¢¼ä»¥åŸ·è¡Œåˆªé™¤</p>
    <input type="password" id="pwdInput" style="width:100%; margin-bottom:15px;">
    <div style="display:flex; gap:10px;">
      <button class="btn-action" style="background:#eee; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-action" id="btnConfirm">ç¢ºèª</button>
    </div>
  </div>
</div>

<script>
/* =========================
   æ ¸å¿ƒé‚è¼¯èˆ‡é é¢åˆ‡æ›
========================= */
const queryCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
const deleteCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
const SCRIPT_DEL_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
const SCRIPT_SET_URL = 'https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec';

let queryRows = [];
let queryHeader = [];
let queryDataRows = [];
let targetRow = null;

function showSection(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".btn-nav").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.currentTarget.classList.add("active");

  if(id === 'delete-section') fetchOrders();
  if(id === 'query-section') loadQueryCSV();
}

/* =========================
   è³‡æ–™è™•ç†å…±ç”¨å‡½å¼
========================= */
function parseCSV(text) {
  const result = [];
  let cur = [];
  let curVal = "";
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];
    if (inQuotes) {
      if (ch === '"' && next === '"') { curVal += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else curVal += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { cur.push(curVal); curVal = ""; }
      else if (ch === '\n') { cur.push(curVal); result.push(cur); cur = []; curVal = ""; }
      else if (ch !== '\r') curVal += ch;
    }
  }
  if (curVal !== "" || cur.length > 0) { cur.push(curVal); result.push(cur); }
  return result;
}

/* =========================
   æŸ¥è©¢åŠŸèƒ½
========================= */
async function loadQueryCSV() {
  try {
    const res = await fetch(`${queryCsvUrl}&t=${Date.now()}`);
    const text = await res.text();
    queryRows = parseCSV(text).filter(r => r.some(c => (c ?? "").trim() !== ""));
    if (queryRows.length > 1) {
      document.getElementById("sheetTitle").innerText = queryRows[0][2] || "è¨‚å–®æŸ¥è©¢";
      queryHeader = queryRows[1];
      queryDataRows = queryRows.slice(2);
      buildBuyerDropdown();
    }
  } catch (e) { console.error("Query Load Error"); }
}

function buildBuyerDropdown() {
  const buyerIdx = queryHeader.indexOf("è³¼è²·äºº");
  const set = new Set();
  queryDataRows.forEach(r => { if(r[buyerIdx]) set.add(r[buyerIdx].trim()); });
  const select = document.getElementById("buyerSelect");
  select.innerHTML = '<option value="">--è«‹é¸æ“‡--</option><option value="ALL">å…¨éƒ¨è¨‚å–®æ¸…å–®</option>';
  [...set].sort().forEach(v => {
    const op = document.createElement("option"); op.value = v; op.textContent = v;
    select.appendChild(op);
  });
}

document.getElementById("buyerSelect").addEventListener("change", (e) => {
  if (e.target.value) renderNormalTable(e.target.value);
});

document.getElementById("listSelect").addEventListener("change", (e) => {
  const opt = e.target.value;
  if (opt === "list1") renderList1();
  else if (opt === "list2") renderList2();
});

function renderNormalTable(buyer) {
  const thead = document.querySelector("#resultTable thead");
  const tbody = document.querySelector("#resultTable tbody");
  thead.innerHTML = `<tr><th>äººå“¡</th><th>é …ç›®</th><th>å–®åƒ¹</th><th>åŠ é£¯</th><th>åŠ æ–™</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>`;
  tbody.innerHTML = "";
  const idx = { item: queryHeader.indexOf("é …ç›®"), price: queryHeader.indexOf("å–®åƒ¹"), rice: queryHeader.indexOf("åŠ é£¯"), add: queryHeader.indexOf("åŠ æ–™"), qty: queryHeader.indexOf("æ•¸é‡"), sub: queryHeader.indexOf("å°è¨ˆ"), buy: queryHeader.indexOf("è³¼è²·äºº") };
  let filtered = buyer === "ALL" ? queryDataRows : queryDataRows.filter(r => (r[idx.buy] ?? "").trim() === buyer);
  let total = 0;
  filtered.forEach(r => {
    const s = Number(r[idx.sub]) || 0; total += s;
    tbody.innerHTML += `<tr><td>${r[idx.buy]}</td><td>${r[idx.item]}</td><td>${r[idx.price]}</td><td>${r[idx.rice]}</td><td>${r[idx.add]}</td><td>${r[idx.qty]}</td><td>${s}</td></tr>`;
  });
  if(buyer !== "ALL") tbody.innerHTML += `<tr class="total-row"><td colspan="6">å€‹äººåˆè¨ˆ</td><td>${total}</td></tr>`;
}

function renderList1() {
  const idxB = queryHeader.indexOf("è³¼è²·äºº"), idxS = queryHeader.indexOf("å°è¨ˆ");
  const tbody = document.querySelector("#resultTable tbody");
  document.querySelector("#resultTable thead").innerHTML = `<tr><th>è³¼è²·äºº</th><th>é‡‘é¡ç¸½è¨ˆ</th></tr>`;
  tbody.innerHTML = "";
  let sum = {}, grand = 0;
  queryDataRows.forEach(r => { const n = r[idxB].trim(), a = Number(r[idxS]) || 0; sum[n] = (sum[n]||0)+a; });
  Object.keys(sum).sort().forEach(n => { grand += sum[n]; tbody.innerHTML += `<tr><td>${n}</td><td>${sum[n]}</td></tr>`; });
  tbody.innerHTML += `<tr class="total-row"><td>å…¨é«”ç¸½è¨ˆ</td><td>${grand}</td></tr>`;
}

function renderList2() {
  const idxI = queryHeader.indexOf("é …ç›®"), idxQ = queryHeader.indexOf("æ•¸é‡");
  const tbody = document.querySelector("#resultTable tbody");
  document.querySelector("#resultTable thead").innerHTML = `<tr><th>é …ç›®</th><th>æ•¸é‡ç¸½è¨ˆ</th></tr>`;
  tbody.innerHTML = "";
  let sum = {}, grand = 0;
  queryDataRows.forEach(r => { const i = r[idxI].trim(), q = Number(r[idxQ]) || 0; sum[i] = (sum[i]||0)+q; });
  Object.keys(sum).sort().forEach(i => { grand += sum[i]; tbody.innerHTML += `<tr><td>${i}</td><td>${sum[i]}</td></tr>`; });
  tbody.innerHTML += `<tr class="total-row"><td>ç¸½æ•¸é‡</td><td>${grand}</td></tr>`;
}

/* =========================
   åˆªé™¤ç®¡ç†
========================= */
async function fetchOrders() {
  toggleLoading(true);
  try {
    const res = await fetch(`${deleteCsvUrl}&t=${Date.now()}`);
    const text = await res.text();
    const rows = parseCSV(text);
    const tbody = document.getElementById('tableBody');
    if (!rows || rows.length < 2) {
      tbody.innerHTML = '<tr><td colspan="6">ç›®å‰å°šç„¡è¨‚å–®</td></tr>';
      return;
    }
    const data = rows.slice(1);
    tbody.innerHTML = data.map((row, i) => `
      <tr>
        <td>${(row[0]||"").substring(5,11)}</td>
        <td>${row[1]||""}</td>
        <td>${row[2]||""}</td>
        <td>${row[3]||""}</td>
        <td style="font-size:11px">${row[4]||""}</td>
        <td><button class="btn-del" onclick="prepareDelete(${i+2})">åˆª</button></td>
      </tr>
    `).join('');
  } finally { toggleLoading(false); }
}

function prepareDelete(row) {
  targetRow = row;
  document.getElementById('modalOverlay').style.display = 'flex';
  document.getElementById('modalDesc').innerText = row === 'all' ? "è­¦å‘Šï¼šå³å°‡æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼" : "è«‹è¼¸å…¥å¯†ç¢¼ç¢ºèªåˆªé™¤";
}

function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

document.getElementById('btnConfirm').onclick = async () => {
  const pwd = document.getElementById('pwdInput').value;
  if(!pwd) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
  closeModal();
  toggleLoading(true);
  try {
    const res = await fetch(SCRIPT_DEL_URL, {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ row: targetRow, password: pwd })
    });
    const result = await res.json();
    alert(result.message);
    if (result.status === 'success') fetchOrders();
  } catch (err) { alert("é€£ç·šå¤±æ•—"); }
  finally { toggleLoading(false); }
};

/* =========================
   è¨­å®šåŠŸèƒ½
========================= */
function loadSettingsOptions() {
  fetch(SCRIPT_SET_URL + "?action=getOptions")
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById('restaurant');
      select.innerHTML = '';
      data.forEach(item => { if(item) select.add(new Option(item, item)); });
    });
}
loadSettingsOptions();

function sendData() {
  const btn = document.getElementById('btn'), status = document.getElementById('status');
  const date = document.getElementById('orderDate').value, store = document.getElementById('restaurant').value;
  const acc = document.getElementById('acc').value, pwd = document.getElementById('pwd').value;

  if (!acc || !pwd) return alert("å¸³å¯†ä¸å¯ç‚ºç©º");
  btn.disabled = true; status.innerText = "è™•ç†ä¸­...";

  const url = `${SCRIPT_SET_URL}?action=submit&date=${encodeURIComponent(date)}&store=${encodeURIComponent(store)}&acc=${encodeURIComponent(acc)}&pwd=${encodeURIComponent(pwd)}`;
  fetch(url).then(res => res.text()).then(text => {
    status.innerText = text;
    status.style.color = text.includes("æˆåŠŸ") ? "green" : "red";
    btn.disabled = false;
  });
}

function toggleLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
</script>

</body>
</html>
