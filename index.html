<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¨‚é¤ç®¡ç†ç³»çµ±ï¼ˆå¡«å–® / æŸ¥è©¢ / åˆªé™¤ / è¨­å®šï¼‰</title>
  <style>
    :root {
      --primary-color: #2e7d32; /* æ£®æ—ç¶  */
      --secondary-color: #4caf50; /* æ·ºç¶  */
      --sky-blue: #e3f2fd;
      --btn-blue: #1e88ff;
      --btn-red: #d32f2f;
      --shadow: 0 12px 30px rgba(0,0,0,0.1);
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft JhengHei", system-ui, sans-serif;
      margin: 0; padding: 30px 15px;
      background: linear-gradient(135deg, var(--sky-blue) 0%, #c8e6c9 100%);
      background-attachment: fixed; min-height: 100vh;
      display: flex; justify-content: center;
      color: #333;
    }

    .wrap { width: min(1100px, 100%); }

    /* æ¨™é¡Œèˆ‡å°è¦½ */
    .title-container { text-align: center; margin-bottom: 25px; }
    h1 {
      background: var(--primary-color); color: white;
      padding: 10px 30px; border-radius: 50px;
      display: inline-flex; align-items: center; gap: 12px;
      font-size: clamp(18px, 4.5vw, 28px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .nav-buttons { 
      display: flex; justify-content: center; gap: 10px; 
      margin-bottom: 25px; flex-wrap: wrap; 
    }

    .btn {
      padding: 12px 20px; font-size: 15px; font-weight: bold; cursor: pointer;
      border: none; color: white; border-radius: 50px;
      background: linear-gradient(180deg, var(--btn-blue) 0%, #1565c0 100%);
      transition: 0.3s; min-width: 120px;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(30,136,255,0.3); }
    .btn.active { background: var(--primary-color); }

    /* å€å¡Šè¨­å®š */
    .section {
      display: none; background: rgba(255, 255, 255, 0.95);
      padding: 25px; border-radius: 20px; box-shadow: var(--shadow);
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .active { display: block; }

    /* å¡«å–®æ¡†æ¶ RWD */
    .google-form-wrapper { width: 100%; border-radius: 12px; overflow: hidden; background: white; }
    .form-frame { width: 100%; height: 1800px; border: none; display: block; }

    @media (max-width: 767px) {
      .google-form-wrapper { overflow: auto !important; -webkit-overflow-scrolling: touch; }
      .form-frame { height: 1200px; overflow: auto !important; }
      body { padding: 15px 10px; }
    }

    /* æŸ¥è©¢é é¢æ§åˆ¶å€ */
    .controls {
      display: flex; flex-wrap: wrap; gap: 15px; 
      justify-content: center; padding: 20px;
      background: #f1f8e9; border-radius: 15px; margin-bottom: 20px;
    }
    .control-group { display: flex; align-items: center; gap: 10px; }
    select, input[type="text"], input[type="password"], input[type="date"] {
      padding: 10px; border: 2px solid #ddd; border-radius: 12px; font-size: 15px;
    }

    /* è¡¨æ ¼æ¨£å¼ */
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
    th { background: var(--primary-color); color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .total-row { font-weight: bold; background: #e8f5e9 !important; }

    /* åˆªé™¤æŒ‰éˆ•èˆ‡å¡ç‰‡æ¨£å¼ */
    .btn-delete {
      background: linear-gradient(180deg, #ff5252 0%, var(--btn-red) 100%);
      padding: 6px 15px; font-size: 14px; min-width: auto;
    }
    .del-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}

    /* è¨­å®šé å¡ç‰‡ */
    .settings-card {
      max-width: 450px; margin: 0 auto; padding: 20px;
      border-radius: 15px; background: white; border-left: 10px solid var(--secondary-color);
    }
    .field { margin-bottom: 15px; text-align: left; }
    .field label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-color); }
    .field input, .field select { width: 100%; }

    /* å½ˆçª—èˆ‡å‹•ç•« */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: none; flex-direction: column; justify-content: center; align-items: center;
    }
    #modalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 3000;
      display: none; justify-content: center; align-items: center;
    }
    #modalBox { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="title-container"><h1>ğŸ± è¨‚é¤ç®¡ç†ç³»çµ±</h1></div>
    
    <div class="nav-buttons">
      <button class="btn active" id="btn-form" onclick="showSection('form-section')">ğŸ“ å¡«å–®å ±å</button>
      <button class="btn" id="btn-query" onclick="showSection('query-section')">ğŸ” è¨‚å–®æŸ¥è©¢</button>
      <button class="btn" id="btn-delete" onclick="showSection('delete-section')">ğŸ—‘ï¸ è¨‚å–®ç®¡ç†</button>
      <button class="btn" id="btn-settings" onclick="showSection('settings-section')">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>

    <div id="form-section" class="section active">
      <div class="google-form-wrapper">
        <iframe class="form-frame" src="https://docs.google.com/forms/d/e/1FAIpQLScooZ_B9Jm7a2-IsEfJhwhLR7hsLyy8knIU3TKuzM7pw_Z5RQ/viewform?usp=header">è¼‰å…¥ä¸­â€¦</iframe>
      </div>
    </div>

    <div id="query-section" class="section">
      <div class="title-container"><h3 id="sheetTitle">è¨‚å–®çµ±è¨ˆæŸ¥è©¢</h3></div>
      <div class="controls">
        <div class="control-group">
          <label>äººå“¡ï¼š</label>
          <select id="buyerSelect"><option value="">--è«‹é¸æ“‡--</option></select>
        </div>
        <div class="control-group">
          <label>çµ±è¨ˆï¼š</label>
          <select id="listSelect">
            <option value="">--è«‹é¸æ“‡--</option>
            <option value="list1">äººå“¡ / é‡‘é¡ç¸½è¨ˆ</option>
            <option value="list2">å“é … / æ•¸é‡ç¸½è¨ˆ</option>
          </select>
        </div>
      </div>
      <div class="table-container">
        <table id="resultTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="delete-section" class="section">
      <div class="del-header">
        <h3 style="margin:0;">ğŸ“‹ è¨‚å–®å³æ™‚æ¸…å–®</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="min-width:auto; background:var(--secondary-color);" onclick="fetchOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="btn btn-delete" style="min-width:auto;" onclick="prepareDelete('all')">ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>æ™‚é–“</th><th>äººå“¡</th><th>å“é …</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="deleteTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="settings-section" class="section">
      <div class="settings-card">
        <div class="title-container"><h3>âš™ï¸ åº—å®¶èˆ‡æ—¥æœŸè¨­å®š</h3></div>
        <div class="field">
          <label>è¨‚é¤æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2026-02-13">
        </div>
        <div class="field">
          <label>åº—å®¶é¸æ“‡</label>
          <select id="restaurantSelect"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
        <div class="field">
          <label>ç®¡ç†å“¡å¸³è™Ÿ</label>
          <input type="text" id="adminAcc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
        </div>
        <div class="field">
          <label>ç®¡ç†å“¡å¯†ç¢¼</label>
          <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>
        <button class="btn" style="width:100%;" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        <p id="settingsStatus" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
      </div>
    </div>
  </div>

  <div id="loadingOverlay"><div style="font-size:40px;">ğŸ±</div><p id="loadingText">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p></div>
  <div id="modalOverlay">
    <div id="modalBox">
      <h3 id="modalTitle">å®‰å…¨é©—è­‰</h3>
      <p id="modalDesc">åŸ·è¡Œåˆªé™¤å‰è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</p>
      <input type="password" id="modalPwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn" style="background:#ccc; flex:1;" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-delete" style="flex:1;" id="btnConfirmDelete">ç¢ºèªåŸ·è¡Œ</button>
      </div>
    </div>
  </div>

  <script>
    // --- åƒæ•¸è¨­å®š ---
    const QUERY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1785595426&single=true&output=csv";
    const DELETE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQISD3cRAvsldviyxyfFi7xQVE12l900EW1yu8_OXOS-uDIr12XAr8zISHsZpJzTBLe_j4kuHWwgdG6/pub?gid=1605656850&single=true&output=csv";
    const GAS_DELETE_URL = "https://script.google.com/macros/s/AKfycbzh9zPFHf6vmhQQR7LrHlokXkPPKnQ2u9ZiqnL6x9kMe4YSaMkrLJJOsqU72OXOIwwo/exec";
    const GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycbxsG1au7MoB7WKs397tM0ZQciSZkdyM_U5Bgb7FBTzOn9OVLFi6_94waAz3HEddovIY/exec";

    let queryDataRows = [];
    let queryHeader = [];

    // --- é€šç”¨åŠŸèƒ½ ---
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".nav-buttons .btn").forEach(b => b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      const btnId = "btn-" + id.split('-')[0];
      if(document.getElementById(btnId)) document.getElementById(btnId).classList.add("active");
      
      if(id === 'delete-section') fetchOrders();
      if(id === 'query-section') loadQueryData();
      if(id === 'settings-section') loadSettingsOptions();
    }

    function showLoading(show, text="è™•ç†ä¸­...") {
      document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
      document.getElementById("loadingText").innerText = text;
    }

    function closeModal() { document.getElementById("modalOverlay").style.display = "none"; }

    // --- æŸ¥è©¢åŠŸèƒ½ ---
    async function loadQueryData() {
      try {
        const res = await fetch(QUERY_CSV);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
        if(rows.length < 2) return;
        
        document.getElementById("sheetTitle").innerText = `${rows[0][2]} (${rows[0][0]})`;
        queryHeader = rows[1];
        queryDataRows = rows.slice(2);
        
        const buyerIdx = queryHeader.indexOf("è³¼è²·äºº");
        const buyers = [...new Set(queryDataRows.map(r => r[buyerIdx]).filter(v => v))];
        const select = document.getElementById("buyerSelect");
        select.innerHTML = '<option value="">--è«‹é¸æ“‡--</option><option value="ALL">å…¨éƒ¨è¨‚å–®</option>';
        buyers.sort().forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
      } catch(e) { console.error("æŸ¥è©¢è¼‰å…¥å¤±æ•—", e); }
    }

    document.getElementById("buyerSelect").onchange = function() {
      document.getElementById("listSelect").value = "";
      renderTable(this.value);
    };

    document.getElementById("listSelect").onchange = function() {
      document.getElementById("buyerSelect").value = "";
      const type = this.value;
      if(type === 'list1') renderSummary("è³¼è²·äºº", "å°è¨ˆ");
      if(type === 'list2') renderSummary("é …ç›®", "æ•¸é‡");
    };

    function renderTable(buyer) {
      const thead = document.querySelector("#resultTable thead");
      const tbody = document.querySelector("#resultTable tbody");
      thead.innerHTML = '<tr><th>äººå“¡</th><th>å“é …</th><th>å–®åƒ¹</th><th>åŠ é£¯</th><th>åŠ æ–™</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>';
      tbody.innerHTML = "";
      
      let filtered = buyer === "ALL" ? queryDataRows : queryDataRows.filter(r => r[queryHeader.indexOf("è³¼è²·äºº")] === buyer);
      let total = 0;
      
      filtered.forEach(r => {
        let sub = parseInt(r[queryHeader.indexOf("å°è¨ˆ")]) || 0;
        total += sub;
        tbody.innerHTML += `<tr><td>${r[queryHeader.indexOf("è³¼è²·äºº")]}</td><td>${r[queryHeader.indexOf("é …ç›®")]}</td><td>${r[queryHeader.indexOf("å–®åƒ¹")]}</td><td>${r[queryHeader.indexOf("åŠ é£¯")]}</td><td>${r[queryHeader.indexOf("åŠ æ–™")]}</td><td>${r[queryHeader.indexOf("æ•¸é‡")]}</td><td>${sub}</td></tr>`;
      });
      if(buyer !== "ALL") tbody.innerHTML += `<tr class="total-row"><td colspan="6">åˆè¨ˆ</td><td>${total}</td></tr>`;
    }

    function renderSummary(keyCol, valCol) {
      const thead = document.querySelector("#resultTable thead");
      const tbody = document.querySelector("#resultTable tbody");
      thead.innerHTML = `<tr><th>${keyCol}</th><th>ç¸½è¨ˆ</th></tr>`;
      tbody.innerHTML = "";
      
      let summary = {};
      let total = 0;
      queryDataRows.forEach(r => {
        let key = r[queryHeader.indexOf(keyCol)];
        let val = parseInt(r[queryHeader.indexOf(valCol)]) || 0;
        if(key) {
          summary[key] = (summary[key] || 0) + val;
          total += val;
        }
      });
      Object.keys(summary).sort().forEach(k => {
        tbody.innerHTML += `<tr><td>${k}</td><td>${summary[k]}</td></tr>`;
      });
      tbody.innerHTML += `<tr class="total-row"><td>ç¸½è¨ˆ</td><td>${total}</td></tr>`;
    }

    // --- åˆªé™¤åŠŸèƒ½ ---
    async function fetchOrders() {
      showLoading(true, "å–å¾—æœ€æ–°è¨‚å–®...");
      try {
        const res = await fetch(`${DELETE_CSV}&t=${Date.now()}`);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
        const tbody = document.getElementById("deleteTableBody");
        tbody.innerHTML = "";
        
        rows.slice(1).forEach((r, idx) => {
          if(!r[1]) return;
          tbody.innerHTML += `<tr>
            <td>${r[0].split(' ')[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td style="font-size:12px">${r[4]}</td>
            <td><button class="btn btn-delete" onclick="prepareDelete(${idx+2})">åˆªé™¤</button></td>
          </tr>`;
        });
      } catch(e) { alert("é€£ç·šå¤±æ•—"); }
      finally { showLoading(false); }
    }

    function prepareDelete(rowIdx) {
      document.getElementById("modalOverlay").style.display = "flex";
      document.getElementById("modalPwdInput").value = "";
      document.getElementById("btnConfirmDelete").onclick = () => executeDelete(rowIdx);
    }

    async function executeDelete(rowIdx) {
      const pwd = document.getElementById("modalPwdInput").value;
      if(!pwd) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
      closeModal();
      showLoading(true, "æ­£åœ¨åŸ·è¡Œåˆªé™¤...");
      
      try {
        const res = await fetch(GAS_DELETE_URL, {
          method: 'POST',
          body: JSON.stringify({ row: rowIdx, password: pwd })
        });
        const result = await res.json();
        alert(result.message);
        if(result.status === 'success') fetchOrders();
      } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
      finally { showLoading(false); }
    }

    // --- è¨­å®šåŠŸèƒ½ ---
    async function loadSettingsOptions() {
      try {
        const res = await fetch(`${GAS_SETTINGS_URL}?action=getOptions`);
        const data = await res.json();
        const sel = document.getElementById("restaurantSelect");
        sel.innerHTML = "";
        data.forEach(opt => sel.innerHTML += `<option value="${opt}">${opt}</option>`);
      } catch(e) { console.error("è¨­å®šé¸å–®è¼‰å…¥å¤±æ•—"); }
    }

    async function saveSettings() {
      const date = document.getElementById("orderDate").value;
      const store = document.getElementById("restaurantSelect").value;
      const acc = document.getElementById("adminAcc").value;
      const pwd = document.getElementById("adminPwd").value;
      const status = document.getElementById("settingsStatus");

      if(!acc || !pwd) { alert("è«‹è¼¸å…¥å¸³å¯†"); return; }
      
      showLoading(true, "å„²å­˜è¨­å®šä¸­...");
      try {
        const url = `${GAS_SETTINGS_URL}?action=submit&date=${date}&store=${encodeURIComponent(store)}&acc=${acc}&pwd=${pwd}`;
        const res = await fetch(url);
        const text = await res.text();
        status.innerText = text;
        status.style.color = text.includes("æˆåŠŸ") ? "green" : "red";
      } catch(e) { status.innerText = "å„²å­˜å¤±æ•—"; }
      finally { showLoading(false); }
    }

  </script>
</body>
</html>
